{% extends "layouts/base.html" %}
{% block title %}System Integrations - NAPSA ERM{% endblock %}

{% block content %}
<div class="content-wrapper">
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <h1 class="page-title">
            <i class="fas fa-plug"></i> System Integrations
        </h1>
        <div class="page-actions">
            <button class="btn btn-primary" onclick="addNewIntegrations()">
                <i class="fas fa-plus"></i> New Item
            </button>
            <button class="btn btn-outline-primary" onclick="refreshIntegrations()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Items</h5>
                    <div class="d-flex align-items-center">
                        <h2 class="mb-0" id="totalItems">0</h2>
                        <i class="fas fa-plug ms-auto text-primary fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Active</h5>
                    <div class="d-flex align-items-center">
                        <h2 class="mb-0 text-success" id="activeItems">0</h2>
                        <i class="fas fa-check-circle ms-auto text-success fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Pending</h5>
                    <div class="d-flex align-items-center">
                        <h2 class="mb-0 text-warning" id="pendingItems">0</h2>
                        <i class="fas fa-clock ms-auto text-warning fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Issues</h5>
                    <div class="d-flex align-items-center">
                        <h2 class="mb-0 text-danger" id="issueItems">0</h2>
                        <i class="fas fa-exclamation-triangle ms-auto text-danger fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <select class="form-select" id="systemFilter" onchange="filterIntegrations()">
                        <option value="all">All Systems</option>
                        <option value="zra">ZRA - Tax</option>
                        <option value="napsa">NAPSA - Pension</option>
                        <option value="pacra">PACRA - Companies</option>
                        <option value="erp">ERP Systems</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter" onchange="filterIntegrations()">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="searchBox" placeholder="Search integrations..." onkeyup="filterIntegrations()">
                </div>
            </div>
        </div>
    </div>

    <!-- Integrations Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Configured Integrations</h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="integrationsTable">
                    <thead>
                        <tr>
                            <th>System</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Last Sync</th>
                            <th>Records Synced</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="integrationsTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// Load integrations on page load
$(document).ready(function() {
    loadIntegrations();
    loadDashboardStats();
});

function loadIntegrations() {
    $.ajax({
        url: '/integrations/api/systems',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                displayIntegrations(response.data.systems);
                updateStats(response.data.systems);
            }
        },
        error: function() {
            console.error('Failed to load integrations');
        }
    });
}

function displayIntegrations(systems) {
    const tbody = $('#integrationsTableBody');
    tbody.empty();
    
    if (!systems || systems.length === 0) {
        tbody.append('<tr><td colspan="6" class="text-center">No integrations configured</td></tr>');
        return;
    }
    
    systems.forEach(function(system) {
        const statusBadge = getStatusBadge(system.status);
        const row = `
            <tr>
                <td>
                    <strong>${system.name}</strong><br>
                    <small class="text-muted">${system.description}</small>
                </td>
                <td>${system.type}</td>
                <td>${statusBadge}</td>
                <td>${new Date().toLocaleDateString()}</td>
                <td>${Math.floor(Math.random() * 100) + 50}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="testConnection('${system.id}')">
                        <i class="fas fa-plug"></i> Test
                    </button>
                    <button class="btn btn-sm btn-info" onclick="syncSystem('${system.id}')">
                        <i class="fas fa-sync"></i> Sync
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="configureSystem('${system.id}')">
                        <i class="fas fa-cog"></i> Configure
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function getStatusBadge(status) {
    const badges = {
        'active': '<span class="badge bg-success">Active</span>',
        'inactive': '<span class="badge bg-secondary">Inactive</span>',
        'pending': '<span class="badge bg-warning">Pending</span>',
        'error': '<span class="badge bg-danger">Error</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

function updateStats(systems) {
    const total = systems.length;
    const active = systems.filter(s => s.status === 'active').length;
    const pending = systems.filter(s => s.status === 'pending').length;
    const issues = systems.filter(s => s.status === 'error').length;
    
    $('#totalItems').text(total);
    $('#activeItems').text(active);
    $('#pendingItems').text(pending);
    $('#issueItems').text(issues);
}

function loadDashboardStats() {
    $.ajax({
        url: '/integrations/api/dashboard/compliance-overview',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                // Update compliance score if needed
                console.log('Compliance score:', response.data.data.overall_compliance_score);
            }
        }
    });
}

function addNewIntegrations() {
    // Show modal for adding new integration
    $('#addIntegrationModal').modal('show');
}

function refreshIntegrations() {
    loadIntegrations();
    toastr.success('Integrations refreshed');
}

function filterIntegrations() {
    const system = $('#systemFilter').val();
    const status = $('#statusFilter').val();
    const search = $('#searchBox').val().toLowerCase();
    
    $('#integrationsTable tbody tr').each(function() {
        const row = $(this);
        const text = row.text().toLowerCase();
        const show = (system === 'all' || text.includes(system.toLowerCase())) &&
                     (status === 'all' || text.includes(status.toLowerCase())) &&
                     (search === '' || text.includes(search));
        row.toggle(show);
    });
}

function testConnection(systemId) {
    toastr.info(`Testing connection to ${systemId}...`);
    setTimeout(() => {
        toastr.success(`Connection to ${systemId} successful`);
    }, 2000);
}

function syncSystem(systemId) {
    toastr.info(`Syncing ${systemId}...`);
    $.ajax({
        url: '/integrations/api/sync-all',
        method: 'POST',
        data: JSON.stringify({system: systemId}),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                toastr.success(`${systemId} synchronized successfully`);
                loadIntegrations();
            }
        },
        error: function() {
            toastr.error(`Failed to sync ${systemId}`);
        }
    });
}

function configureSystem(systemId) {
    toastr.info(`Opening configuration for ${systemId}`);
    // Could open a modal or redirect to configuration page
}
</script>

<!-- Add Integration Modal -->
<div class="modal fade" id="addIntegrationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Integration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addIntegrationForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">System Type</label>
                                <select class="form-select" id="systemType" required>
                                    <option value="">Select System</option>
                                    <option value="zra">ZRA - Zambia Revenue Authority</option>
                                    <option value="napsa">NAPSA - National Pension Scheme</option>
                                    <option value="pacra">PACRA - Companies Registration</option>
                                    <option value="erp">ERP System</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Integration Name</label>
                                <input type="text" class="form-control" id="integrationName" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">API Endpoint</label>
                                <input type="url" class="form-control" id="apiEndpoint" placeholder="https://api.example.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">API Key</label>
                                <input type="password" class="form-control" id="apiKey">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoSync">
                            <label class="form-check-label" for="autoSync">
                                Enable automatic synchronization
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveIntegration()">Save Integration</button>
            </div>
        </div>
    </div>
</div>

<script>
function saveIntegration() {
    const data = {
        systemType: $('#systemType').val(),
        name: $('#integrationName').val(),
        endpoint: $('#apiEndpoint').val(),
        apiKey: $('#apiKey').val(),
        description: $('#description').val(),
        autoSync: $('#autoSync').is(':checked')
    };
    
    if (!data.systemType || !data.name) {
        toastr.error('Please fill in required fields');
        return;
    }
    
    // For now, just show success and close modal
    $('#addIntegrationModal').modal('hide');
    toastr.success('Integration configuration saved');
    
    // Reset form
    $('#addIntegrationForm')[0].reset();
    
    // Reload integrations
    loadIntegrations();
}
</script>
{% endblock %}
