{% extends "layouts/base.html" %}

{% block title %}Risk Heat Map - NAPSA ERM System{% endblock %}

{% block content %}
<div style="background: #f5f5f5; min-height: 100vh; padding: 2rem 0;">
    <div class="container-fluid">
        <div style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h1 style="color: #1e40af;"><i class="fas fa-fire me-2"></i>Risk Heat Map</h1>
            <p class="text-muted">Interactive 5x5 risk matrix showing likelihood vs impact</p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div style="background: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2rem; font-weight: 700; color: #ef4444;" id="criticalCount">0</div>
                <div>Critical</div>
            </div>
            <div style="background: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;" id="highCount">0</div>
                <div>High</div>
            </div>
            <div style="background: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2rem; font-weight: 700; color: #06b6d4;" id="mediumCount">0</div>
                <div>Medium</div>
            </div>
            <div style="background: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="font-size: 2rem; font-weight: 700; color: #10b981;" id="lowCount">0</div>
                <div>Low</div>
            </div>
        </div>

        <div style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h4 class="text-center mb-3">NAPSA Risk Matrix (5x5)</h4>
            <div id="riskMatrix" style="display: grid; grid-template-columns: 60px repeat(5, 1fr); grid-template-rows: 30px repeat(5, 1fr); gap: 2px; background: #e5e7eb; padding: 10px; border-radius: 8px; max-width: 800px; margin: 0 auto;">
                <!-- Matrix will be populated by JavaScript -->
            </div>
        </div>

        <div id="riskDetails" style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;">
            <h5 id="detailsTitle">Risk Details</h5>
            <div id="riskList"></div>
        </div>
    </div>
</div>

<script>
let allRisks = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeHeatMap();
    loadRiskData();
});

function initializeHeatMap() {
    const matrix = document.getElementById('riskMatrix');
    
    // Headers
    matrix.innerHTML = '<div style="background: #1e40af; color: white; display: flex; align-items: center; justify-content: center; border-radius: 4px;"></div>';
    for (let i = 1; i <= 5; i++) {
        const header = document.createElement('div');
        header.style = 'background: #1e40af; color: white; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: 600;';
        header.textContent = i;
        matrix.appendChild(header);
    }
    
    // Matrix cells
    for (let impact = 5; impact >= 1; impact--) {
        // Impact label
        const label = document.createElement('div');
        label.style = 'background: #1e40af; color: white; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: 600;';
        label.textContent = impact;
        matrix.appendChild(label);
        
        // Likelihood cells
        for (let likelihood = 1; likelihood <= 5; likelihood++) {
            const cell = document.createElement('div');
            const score = likelihood * impact;
            let bgColor = '#d1fae5', textColor = '#065f46'; // Low risk
            
            if (score >= 17) { bgColor = '#fecaca'; textColor = '#991b1b'; } // Critical
            else if (score >= 10) { bgColor = '#fed7aa'; textColor = '#c2410c'; } // High
            else if (score >= 5) { bgColor = '#fef3c7'; textColor = '#92400e'; } // Medium
            
            cell.style = `background: ${bgColor}; color: ${textColor}; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: 600; cursor: pointer; min-height: 60px; transition: transform 0.3s;`;
            cell.dataset.likelihood = likelihood;
            cell.dataset.impact = impact;
            cell.textContent = '0';
            cell.onclick = () => showRisksInCell(likelihood, impact);
            cell.onmouseenter = () => cell.style.transform = 'scale(1.05)';
            cell.onmouseleave = () => cell.style.transform = 'scale(1)';
            
            matrix.appendChild(cell);
        }
    }
}

async function loadRiskData() {
    try {
        const response = await fetch('/api/risks');
        const data = await response.json();
        
        if (data.success && data.data) {
            allRisks = data.data;
            updateHeatMap();
            updateStatistics();
        }
    } catch (error) {
        console.error('Error loading risks:', error);
    }
}

function updateHeatMap() {
    // Reset counts
    document.querySelectorAll('[data-likelihood]').forEach(cell => cell.textContent = '0');
    
    // Count risks in each cell
    const counts = {};
    allRisks.forEach(risk => {
        const key = `${risk.likelihood || 1}-${risk.impact || 1}`;
        counts[key] = (counts[key] || 0) + 1;
    });
    
    // Update cell counts
    Object.entries(counts).forEach(([key, count]) => {
        const [likelihood, impact] = key.split('-');
        const cell = document.querySelector(`[data-likelihood="${likelihood}"][data-impact="${impact}"]`);
        if (cell) cell.textContent = count;
    });
}

function updateStatistics() {
    let critical = 0, high = 0, medium = 0, low = 0;
    
    allRisks.forEach(risk => {
        const score = (risk.likelihood || 1) * (risk.impact || 1);
        if (score >= 17) critical++;
        else if (score >= 10) high++;
        else if (score >= 5) medium++;
        else low++;
    });
    
    document.getElementById('criticalCount').textContent = critical;
    document.getElementById('highCount').textContent = high;
    document.getElementById('mediumCount').textContent = medium;
    document.getElementById('lowCount').textContent = low;
}

function showRisksInCell(likelihood, impact) {
    const cellRisks = allRisks.filter(r => 
        (r.likelihood || 1) === likelihood && (r.impact || 1) === impact
    );
    
    if (cellRisks.length === 0) return;
    
    document.getElementById('detailsTitle').textContent = 
        `Risks (Likelihood: ${likelihood}, Impact: ${impact})`;
    
    const riskList = document.getElementById('riskList');
    riskList.innerHTML = cellRisks.map(risk => `
        <div style="padding: 1rem; border: 1px solid #e5e7eb; margin: 0.5rem 0; border-radius: 8px;">
            <h6 style="color: #1e40af; margin-bottom: 0.5rem;">${risk.title}</h6>
            <p style="margin-bottom: 0.5rem;">${(risk.description || '').substring(0, 200)}${risk.description && risk.description.length > 200 ? '...' : ''}</p>
            <small style="color: #6b7280;">${risk.department} - ${risk.category}</small>
        </div>
    `).join('');
    
    document.getElementById('riskDetails').style.display = 'block';
    document.getElementById('riskDetails').scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}