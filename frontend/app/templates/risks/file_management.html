{% extends "layouts/base.html" %}

{% block title %}Risk Document Management - NAPSA ERM{% endblock %}

{% block styles %}
<style>
    :root {
        --sidebar-color: #1e3a8a;
        --orange-hover: #f59e0b;
        --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    .btn-primary, .btn-secondary, .btn-outline-primary, .btn-outline-secondary {
        background: var(--sidebar-color) !important;
        border-color: var(--sidebar-color) !important;
        color: white !important;
        padding: 0.5rem 1.25rem;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary:hover, .btn-secondary:hover, .btn-outline-primary:hover, .btn-outline-secondary:hover {
        background: var(--orange-hover) !important;
        border-color: var(--orange-hover) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .col-md-3:nth-child(1) .stat-card::before {
        background: var(--gradient-1);
    }

    .col-md-3:nth-child(2) .stat-card::before {
        background: var(--gradient-2);
    }

    .col-md-3:nth-child(3) .stat-card::before {
        background: var(--gradient-3);
    }

    .col-md-3:nth-child(4) .stat-card::before {
        background: var(--gradient-4);
    }

    .file-manager {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .file-category {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .file-category:hover {
        background: #f3f4f6;
        transform: translateX(4px);
    }
    
    .file-category.active {
        background: #dbeafe;
        border-color: var(--sidebar-color);
    }
    
    .file-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: white;
        transition: all 0.3s ease;
    }
    
    .file-item:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .file-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        margin-right: 1rem;
    }
    
    .file-icon.pdf { background: #fee2e2; color: #dc2626; }
    .file-icon.docx { background: #dbeafe; color: #2563eb; }
    .file-icon.xlsx { background: #d1fae5; color: #10b981; }
    .file-icon.png, .file-icon.jpg { background: #fef3c7; color: #f59e0b; }
    
    .file-details {
        flex: 1;
    }
    
    .file-name {
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.25rem;
    }
    
    .file-meta {
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .file-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .upload-zone {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: #f9fafb;
        transition: all 0.3s ease;
    }
    
    .upload-zone.dragover {
        border-color: var(--sidebar-color);
        background: #eff6ff;
    }
    
    .integrity-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .integrity-valid {
        background: #d1fae5;
        color: #065f46;
    }
    
    .integrity-invalid {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .storage-stats {
        background: var(--gradient-1);
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .storage-bar {
        background: rgba(255,255,255,0.2);
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
    }
    
    .storage-progress {
        background: white;
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Action Buttons -->
            <div class="mb-4">
                <button class="btn btn-primary" onclick="uploadNewFile()">
                    <i class="fas fa-upload me-2"></i>Upload File
                </button>
                <button class="btn btn-secondary ms-2" onclick="createFolder()">
                    <i class="fas fa-folder-plus me-1"></i>New Folder
                </button>
                <button class="btn btn-secondary ms-2" onclick="refreshFileList()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button class="btn btn-secondary ms-2" onclick="exportFileList()">
                    <i class="fas fa-download me-1"></i>Export List
                </button>
            </div>

            <!-- Page Description -->
            <div class="mb-3">
                <div>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="$('#uploadModal').modal('show')">
                        <i class="fas fa-upload mr-2"></i>Upload Document
                    </button>
                </div>
            </div>

            <!-- Storage Statistics -->
            <div class="storage-stats">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-1">Total Files</div>
                        <h3 id="totalFiles">0</h3>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-1">Storage Used</div>
                        <h3 id="storageUsed">0 MB</h3>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-1">Categories</div>
                        <h3 id="categoriesCount">0</h3>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-1">Verified Files</div>
                        <h3 id="verifiedFiles">0</h3>
                    </div>
                </div>
                <div class="storage-bar">
                    <div class="storage-progress" id="storageProgress" style="width: 0%"></div>
                </div>
                <div class="small mt-2">
                    <span id="storagePercent">0%</span> of 10 GB used
                </div>
            </div>

            <div class="row">
                <!-- Categories Sidebar -->
                <div class="col-md-3">
                    <div class="file-manager">
                        <h5 class="mb-3">Categories</h5>
                        <div id="categoriesList">
                            <!-- Categories will be loaded here -->
                        </div>
                        <button class="btn btn-sm btn-outline-primary w-100 mt-3" onclick="createCategory()">
                            <i class="fas fa-plus"></i> New Category
                        </button>
                    </div>
                </div>

                <!-- Files List -->
                <div class="col-md-9">
                    <div class="file-manager">
                        <!-- Upload Zone -->
                        <div class="upload-zone mb-4" id="dropZone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <p class="mb-1">Drag and drop files here or click to browse</p>
                            <p class="text-muted small">Supported formats: PDF, DOCX, XLSX, PNG, JPG</p>
                            <input type="file" id="fileInput" multiple style="display: none" accept=".pdf,.docx,.xlsx,.png,.jpg,.jpeg">
                        </div>

                        <!-- Files List -->
                        <h5 class="mb-3">Documents</h5>
                        <div id="filesList">
                            <!-- Files will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Document</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="uploadForm">
                    <div class="form-group">
                        <label>Select File *</label>
                        <input type="file" class="form-control-file" id="modalFileInput" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Category *</label>
                        <select class="form-control" id="fileCategory" required>
                            <!-- Categories will be loaded here -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="fileDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="fileTags" placeholder="risk, assessment, 2024">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Related Entity Type</label>
                                <select class="form-control" id="relatedEntityType">
                                    <option value="">None</option>
                                    <option value="risk">Risk</option>
                                    <option value="control">Control</option>
                                    <option value="incident">Incident</option>
                                    <option value="assessment">Assessment</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Related Entity ID</label>
                                <input type="number" class="form-control" id="relatedEntityId">
                            </div>
                        </div>
                    </div>
                    
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="isPublic">
                        <label class="custom-control-label" for="isPublic">
                            Make this file publicly accessible
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadFile()">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- File Details Modal -->
<div class="modal fade" id="fileDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="fileDetailsContent">
                <!-- File details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadBtn">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let categories = [];
let files = [];
let selectedCategory = null;

// Initialize on page load
$(document).ready(function() {
    loadCategories();
    loadFiles();
    loadStatistics();
    setupDragDrop();
});

// Load file categories
function loadCategories() {
    $.ajax({
        url: '/api/v1/risks/file-categories',
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        success: function(response) {
            categories = response || [];
            renderCategories();
        },
        error: function() {
            // Use mock data if API fails
            categories = getMockCategories();
            renderCategories();
        }
    });
}

// Load files
function loadFiles(categoryId = null) {
    const params = categoryId ? { category_id: categoryId } : {};
    
    $.ajax({
        url: '/api/v1/risks/files',
        method: 'GET',
        data: params,
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        success: function(response) {
            files = response || [];
            renderFiles();
        },
        error: function() {
            // Use mock data if API fails
            files = getMockFiles();
            renderFiles();
        }
    });
}

// Load statistics
function loadStatistics() {
    $.ajax({
        url: '/api/v1/risks/files/stats/summary',
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        success: function(response) {
            updateStatistics(response);
        },
        error: function() {
            // Use mock statistics
            updateStatistics({
                total_files: 42,
                total_size_mb: 256.5,
                categories_count: 6,
                verified_files: 38
            });
        }
    });
}

// Render categories
function renderCategories() {
    const container = $('#categoriesList');
    const select = $('#fileCategory');
    
    container.empty();
    select.empty().append('<option value="">Select category</option>');
    
    // Add "All Files" option
    container.append(`
        <div class="file-category ${!selectedCategory ? 'active' : ''}" onclick="selectCategory(null)">
            <i class="fas fa-folder mr-2"></i> All Files
            <span class="badge badge-secondary float-right">${files.length}</span>
        </div>
    `);
    
    categories.forEach(category => {
        const categoryCard = `
            <div class="file-category ${selectedCategory === category.id ? 'active' : ''}" 
                 onclick="selectCategory(${category.id})">
                <i class="fas fa-folder mr-2"></i> ${category.name}
                <span class="badge badge-secondary float-right">0</span>
            </div>
        `;
        container.append(categoryCard);
        
        select.append(`<option value="${category.id}">${category.name}</option>`);
    });
}

// Select category
function selectCategory(categoryId) {
    selectedCategory = categoryId;
    renderCategories();
    loadFiles(categoryId);
}

// Render files
function renderFiles() {
    const container = $('#filesList');
    container.empty();
    
    if (files.length === 0) {
        container.html(`
            <div class="text-center text-muted py-4">
                <i class="fas fa-file-alt fa-3x mb-3"></i>
                <p>No files found</p>
            </div>
        `);
        return;
    }
    
    files.forEach(file => {
        const fileItem = `
            <div class="file-item">
                <div class="file-icon ${file.file_extension}">
                    <i class="fas fa-file-${getFileIcon(file.file_extension)}"></i>
                </div>
                <div class="file-details">
                    <div class="file-name">${file.original_filename}</div>
                    <div class="file-meta">
                        ${formatFileSize(file.file_size)} • 
                        Uploaded ${formatDate(file.uploaded_at)} • 
                        ${file.tags ? file.tags.join(', ') : 'No tags'}
                    </div>
                </div>
                <div class="file-actions">
                    <button class="btn btn-sm btn-outline-info" onclick="viewFileDetails(${file.id})">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="verifyFile(${file.id})">
                        <i class="fas fa-check-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="downloadFile(${file.id})">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFile(${file.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.append(fileItem);
    });
}

// Setup drag and drop
function setupDragDrop() {
    const dropZone = $('#dropZone');
    const fileInput = $('#fileInput');
    
    dropZone.on('click', function() {
        fileInput.click();
    });
    
    dropZone.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    dropZone.on('dragleave', function() {
        $(this).removeClass('dragover');
    });
    
    dropZone.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        
        const files = e.originalEvent.dataTransfer.files;
        handleFileSelect(files);
    });
    
    fileInput.on('change', function() {
        handleFileSelect(this.files);
    });
}

// Handle file selection
function handleFileSelect(files) {
    if (files.length > 0) {
        // Auto-open upload modal with first file
        $('#modalFileInput')[0].files = files;
        $('#uploadModal').modal('show');
    }
}

// Upload file
function uploadFile() {
    const fileInput = $('#modalFileInput')[0];
    if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select a file');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('category_id', $('#fileCategory').val() || 1);
    formData.append('description', $('#fileDescription').val());
    formData.append('tags', $('#fileTags').val());
    formData.append('is_public', $('#isPublic').is(':checked'));
    formData.append('related_entity_type', $('#relatedEntityType').val());
    formData.append('related_entity_id', $('#relatedEntityId').val());
    
    $.ajax({
        url: '/api/v1/risks/files/upload',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        success: function(response) {
            $('#uploadModal').modal('hide');
            showNotification('success', 'File uploaded successfully');
            loadFiles();
            loadStatistics();
        },
        error: function(xhr) {
            showNotification('error', 'Failed to upload file: ' + (xhr.responseJSON?.detail || 'Unknown error'));
        }
    });
}

// Download file
function downloadFile(fileId) {
    window.location.href = `/api/v1/risks/files/${fileId}/download`;
}

// Verify file integrity
function verifyFile(fileId) {
    $.ajax({
        url: `/api/v1/risks/files/${fileId}/verify`,
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        success: function(response) {
            const message = response.valid 
                ? 'File integrity verified successfully' 
                : 'File integrity check failed - file may have been modified';
            showNotification(response.valid ? 'success' : 'warning', message);
        }
    });
}

// Delete file
function deleteFile(fileId) {
    if (!confirm('Are you sure you want to delete this file?')) return;
    
    $.ajax({
        url: `/api/v1/risks/files/${fileId}`,
        method: 'DELETE',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        },
        success: function() {
            showNotification('success', 'File deleted successfully');
            loadFiles();
            loadStatistics();
        }
    });
}

// Update statistics
function updateStatistics(stats) {
    $('#totalFiles').text(stats.total_files || 0);
    $('#storageUsed').text(`${stats.total_size_mb || 0} MB`);
    $('#categoriesCount').text(stats.categories_count || categories.length);
    $('#verifiedFiles').text(stats.verified_files || 0);
    
    const storagePercent = ((stats.total_size_mb || 0) / 10240) * 100; // 10GB limit
    $('#storageProgress').css('width', `${storagePercent}%`);
    $('#storagePercent').text(`${storagePercent.toFixed(1)}%`);
}

// Mock data functions
function getMockCategories() {
    return [
        { id: 1, name: 'Risk Assessments', allowed_extensions: ['pdf', 'docx'] },
        { id: 2, name: 'Policies', allowed_extensions: ['pdf', 'docx'] },
        { id: 3, name: 'Incidents', allowed_extensions: ['pdf', 'xlsx'] },
        { id: 4, name: 'Evidence', allowed_extensions: ['png', 'jpg', 'pdf'] },
        { id: 5, name: 'Audits', allowed_extensions: ['pdf', 'xlsx'] },
        { id: 6, name: 'General', allowed_extensions: ['pdf', 'docx', 'xlsx'] }
    ];
}

function getMockFiles() {
    return [
        {
            id: 1,
            original_filename: 'Risk_Assessment_2024.pdf',
            file_size: 2457600,
            file_extension: 'pdf',
            uploaded_at: new Date(),
            tags: ['risk', 'assessment', '2024']
        },
        {
            id: 2,
            original_filename: 'Compliance_Report.xlsx',
            file_size: 1048576,
            file_extension: 'xlsx',
            uploaded_at: new Date(),
            tags: ['compliance', 'report']
        }
    ];
}

// Utility functions
function getFileIcon(extension) {
    const icons = {
        'pdf': 'pdf',
        'docx': 'word',
        'xlsx': 'excel',
        'png': 'image',
        'jpg': 'image',
        'jpeg': 'image'
    };
    return icons[extension] || 'alt';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

function formatDate(date) {
    return new Date(date).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

function showNotification(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 
                       type === 'warning' ? 'alert-warning' : 'alert-danger';
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999;">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `;
    $('body').append(notification);
    setTimeout(() => $('.alert').fadeOut(), 3000);
}
</script>
{% endblock %}