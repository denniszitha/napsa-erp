{% extends "layouts/base.html" %}

{% block title %}Dashboard - NAPSA ERM System{% endblock %}

{% block page_title %}Risk & Compliance Dashboard{% endblock %}
{% block breadcrumb %}Dashboard{% endblock %}

{% block styles %}
<style>
    /* NAPSA Brand Colors */
    :root {
        --napsa-blue: #002868;
        --napsa-orange: #FFA500;
        --napsa-green: #90EE90;
        --napsa-gold: #FFD700;
        --risk-color: #FFA500;
        --compliance-color: #90EE90;
    }

    /* Dashboard Container */
    .dashboard-container {
        background: #f8f9fa;
        min-height: calc(100vh - 70px);
    }

    /* Section Headers */
    .section-header {
        padding: 1.5rem 0;
        margin-bottom: 2rem;
        border-bottom: 3px solid;
    }

    .section-header.risk-section {
        border-color: var(--napsa-orange);
    }

    .section-header.compliance-section {
        border-color: var(--napsa-green);
    }

    /* Metric Cards */
    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        height: 100%;
        border-left: 4px solid;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .metric-card.risk {
        border-left-color: var(--napsa-orange);
    }

    .metric-card.compliance {
        border-left-color: var(--napsa-green);
    }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 24px;
    }

    .metric-card.risk .metric-icon {
        background: rgba(255, 165, 0, 0.1);
        color: var(--napsa-orange);
    }

    .metric-card.compliance .metric-icon {
        background: rgba(144, 238, 144, 0.1);
        color: var(--napsa-green);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.875rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Risk Matrix */
    .risk-matrix-container {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .matrix-cell {
        padding: 1rem;
        text-align: center;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 4px;
    }

    .matrix-cell:hover {
        transform: scale(1.05);
    }

    .risk-very-low { background: #22c55e; color: white; }
    .risk-low { background: #86efac; }
    .risk-medium { background: #fbbf24; }
    .risk-high { background: #fb923c; }
    .risk-very-high { background: #ef4444; color: white; }

    /* Charts */
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: 400px;
    }

    /* Quick Actions */
    .quick-action {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
    }

    .quick-action:hover {
        border-color: var(--napsa-orange);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .quick-action i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    .quick-action.risk i {
        color: var(--napsa-orange);
    }

    .quick-action.compliance i {
        color: var(--napsa-green);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container-fluid">
        <!-- Risk Management Section -->
        <div class="section-header risk-section">
            <h2 class="mb-0">
                <i class="fas fa-exclamation-triangle" style="color: var(--napsa-orange);"></i>
                Risk Management Overview
            </h2>
        </div>

        <!-- Risk Metrics -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card risk">
                    <div class="metric-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="metric-value" id="total-risks">{{ total_risks|default(0) }}</div>
                    <div class="metric-label">Total Risks</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card risk">
                    <div class="metric-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="metric-value" id="critical-risks">{{ critical_risks|default(0) }}</div>
                    <div class="metric-label">Critical Risks</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card risk">
                    <div class="metric-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="metric-value" id="open-incidents">{{ open_incidents|default(0) }}</div>
                    <div class="metric-label">Open Incidents</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card risk">
                    <div class="metric-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="metric-value" id="kri-alerts">{{ kri_alerts|default(0) }}</div>
                    <div class="metric-label">KRI Alerts</div>
                </div>
            </div>
        </div>

        <!-- Risk Matrix and Top Risks -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="risk-matrix-container">
                    <h5 class="mb-3">Risk Assessment Matrix</h5>
                    <div id="risk-matrix">
                        <!-- Risk matrix will be populated here -->
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Very Low</th>
                                    <th>Low</th>
                                    <th>Medium</th>
                                    <th>High</th>
                                    <th>Very High</th>
                                </tr>
                            </thead>
                            <tbody id="matrix-body">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Top 5 Risks Requiring Attention</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="top-risks-list">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Quick Actions -->
        <div class="row mb-5">
            <div class="col-12">
                <h5 class="mb-3">Risk Management Quick Actions</h5>
            </div>
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <a href="{{ url_for('risks.create') }}" class="quick-action risk">
                    <i class="fas fa-plus-circle"></i>
                    <span>New Risk</span>
                </a>
            </div>
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <a href="{{ url_for('incidents.create') }}" class="quick-action risk">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Report Incident</span>
                </a>
            </div>
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <a href="{{ url_for('rcsa.create') }}" class="quick-action risk">
                    <i class="fas fa-clipboard-check"></i>
                    <span>New RCSA</span>
                </a>
            </div>
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <a href="{{ url_for('kri.dashboard') }}" class="quick-action risk">
                    <i class="fas fa-chart-line"></i>
                    <span>View KRIs</span>
                </a>
            </div>
        </div>

        <!-- Compliance Section -->
        <div class="section-header compliance-section">
            <h2 class="mb-0">
                <i class="fas fa-check-circle" style="color: var(--napsa-green);"></i>
                Compliance & Assurance Overview
            </h2>
        </div>

        <!-- Compliance Metrics -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card compliance">
                    <div class="metric-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="metric-value">{{ compliance_score|default(85) }}%</div>
                    <div class="metric-label">Compliance Score</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card compliance">
                    <div class="metric-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="metric-value">{{ audit_findings|default(0) }}</div>
                    <div class="metric-label">Audit Findings</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card compliance">
                    <div class="metric-icon">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div class="metric-value">{{ active_policies|default(0) }}</div>
                    <div class="metric-label">Active Policies</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card compliance">
                    <div class="metric-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="metric-value">{{ pending_assessments|default(0) }}</div>
                    <div class="metric-label">Pending Assessments</div>
                </div>
            </div>
        </div>

        <!-- Compliance Charts -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h5>Compliance Trend</h5>
                    <canvas id="compliance-trend-chart"></canvas>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h5>Regulatory Framework Status</h5>
                    <canvas id="framework-status-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Compliance Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <h5 class="mb-3">Compliance Quick Actions</h5>
            </div>
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <a href="{{ url_for('compliance.index') }}" class="quick-action compliance">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Compliance Check</span>
                </a>
            </div>
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <a href="{{ url_for('audit.create') }}" class="quick-action compliance">
                    <i class="fas fa-search"></i>
                    <span>New Audit</span>
                </a>
            </div>
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <a href="{{ url_for('policies.index') }}" class="quick-action compliance">
                    <i class="fas fa-file-alt"></i>
                    <span>View Policies</span>
                </a>
            </div>
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <a href="{{ url_for('reports.index') }}" class="quick-action compliance">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load dashboard data
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    initializeCharts();
});

function loadDashboardData() {
    // Load risk statistics
    fetch('/api/risks/stats/summary')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-risks').textContent = data.data.total_risks || 0;
                document.getElementById('critical-risks').textContent = data.data.critical_risks || 0;
            }
        })
        .catch(error => console.error('Error loading risk stats:', error));

    // Load other metrics
    fetch('/api/dashboard/overview')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                // Update metrics if elements exist
                updateElementText('open-incidents', data.data.open_incidents);
                updateElementText('kri-alerts', data.data.kri_alerts);
                updateElementText('compliance-score', data.data.compliance_score);
                updateElementText('audit-findings', data.data.audit_findings);
                updateElementText('pending-assessments', data.data.pending_assessments);
            }
        })
        .catch(error => console.error('Error loading dashboard data:', error));

    // Load risk matrix
    loadRiskMatrix();
    
    // Load top risks
    loadTopRisks();
}

function updateElementText(id, value) {
    const element = document.getElementById(id);
    if (element && value !== undefined) {
        element.textContent = value;
    }
}

function loadRiskMatrix() {
    // Implementation for risk matrix
    const matrixBody = document.getElementById('matrix-body');
    if (matrixBody) {
        const levels = ['Very High', 'High', 'Medium', 'Low', 'Very Low'];
        levels.forEach(level => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <th>${level}</th>
                <td class="matrix-cell risk-very-low">0</td>
                <td class="matrix-cell risk-low">0</td>
                <td class="matrix-cell risk-medium">0</td>
                <td class="matrix-cell risk-high">0</td>
                <td class="matrix-cell risk-very-high">0</td>
            `;
            matrixBody.appendChild(row);
        });
    }
}

function loadTopRisks() {
    fetch('/api/top-risks')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('top-risks-list');
            if (container && data.data) {
                container.innerHTML = '';
                data.data.slice(0, 5).forEach(risk => {
                    const item = document.createElement('a');
                    item.href = `/risks/${risk.id}`;
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${risk.title}</h6>
                                <small class="text-muted">${risk.category}</small>
                            </div>
                            <span class="badge bg-danger">Score: ${risk.inherent_risk_score}</span>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
        })
        .catch(error => console.error('Error loading top risks:', error));
}

function initializeCharts() {
    // Compliance Trend Chart
    const complianceTrendCtx = document.getElementById('compliance-trend-chart');
    if (complianceTrendCtx) {
        new Chart(complianceTrendCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Compliance Score',
                    data: [82, 83, 85, 84, 85, 85],
                    borderColor: 'rgb(144, 238, 144)',
                    backgroundColor: 'rgba(144, 238, 144, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Framework Status Chart
    const frameworkCtx = document.getElementById('framework-status-chart');
    if (frameworkCtx) {
        new Chart(frameworkCtx, {
            type: 'bar',
            data: {
                labels: ['ISO 31000', 'COSO ERM', 'NAPSA Act', 'Basel III'],
                datasets: [{
                    label: 'Compliance %',
                    data: [85, 78, 92, 73],
                    backgroundColor: [
                        'rgba(144, 238, 144, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(144, 238, 144, 0.8)',
                        'rgba(255, 206, 86, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
}
</script>
{% endblock %}