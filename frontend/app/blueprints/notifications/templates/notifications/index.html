<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Management - NAPSA ERM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .notification-card {
            transition: transform 0.2s;
            height: 100%;
        }
        .notification-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        .status-partial {
            background-color: #ffc107;
        }
        .test-result {
            display: none;
            margin-top: 15px;
        }
        .alert-type-card {
            border-left: 4px solid #0d6efd;
            background: #f8f9fa;
        }
        .form-section {
            background: #ffffff;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-bell"></i> Notification Management</h2>
                <p class="text-muted">Configure and manage email and SMS notifications for the NAPSA ERM system</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" onclick="refreshStatus()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                </button>
            </div>
        </div>

        <!-- System Status -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card notification-card">
                    <div class="card-header">
                        <h5><i class="bi bi-envelope"></i> Email Service Status</h5>
                    </div>
                    <div class="card-body" id="emailStatus">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Checking status...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card notification-card">
                    <div class="card-header">
                        <h5><i class="bi bi-phone"></i> SMS Service Status</h5>
                    </div>
                    <div class="card-body" id="smsStatus">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Checking status...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Notifications -->
        <div class="form-section">
            <h4><i class="bi bi-check-circle"></i> Test Notification System</h4>
            <p class="text-muted">Test email and SMS delivery to ensure the system is working correctly</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Test Email Address</label>
                        <input type="email" class="form-control" id="testEmail" placeholder="Enter email address">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Test Phone Number</label>
                        <input type="text" class="form-control" id="testPhone" placeholder="260979123456">
                        <div class="form-text">Format: 260979123456 (including country code)</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="testNotifications()">
                <i class="bi bi-play-circle"></i> Test Notifications
            </button>
            
            <div class="test-result alert" id="testResult"></div>
        </div>

        <!-- Send Custom Notification -->
        <div class="form-section">
            <h4><i class="bi bi-send"></i> Send Custom Notification</h4>
            <p class="text-muted">Send a custom notification to specified recipients</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Email Recipients</label>
                        <textarea class="form-control" id="emailRecipients" rows="3" 
                                  placeholder="admin@napsa.co.zm&#10;manager@napsa.co.zm"></textarea>
                        <div class="form-text">One email per line</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">SMS Recipients</label>
                        <textarea class="form-control" id="smsRecipients" rows="3" 
                                  placeholder="260979123456&#10;260977654321"></textarea>
                        <div class="form-text">One phone number per line (with country code)</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-control" id="notificationSubject" 
                               placeholder="Notification subject">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="notificationPriority">
                            <option value="low">Low</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Message</label>
                <textarea class="form-control" id="notificationMessage" rows="4" 
                          placeholder="Enter your notification message here..."></textarea>
                <div class="form-text">SMS messages will be truncated to 160 characters</div>
            </div>
            
            <button class="btn btn-primary" onclick="sendCustomNotification()">
                <i class="bi bi-send"></i> Send Notification
            </button>
            
            <div class="test-result alert" id="customResult"></div>
        </div>

        <!-- Alert Types -->
        <div class="row">
            <div class="col-12">
                <h4><i class="bi bi-exclamation-triangle"></i> Available Alert Types</h4>
                <p class="text-muted">The system supports various automated alert types</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card alert-type-card">
                    <div class="card-body">
                        <h6><i class="bi bi-graph-down text-danger"></i> KRI Breach Alerts</h6>
                        <p class="text-muted small">Automatic notifications when Key Risk Indicators exceed thresholds</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="showKRIExample()">
                            View Example
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card alert-type-card">
                    <div class="card-body">
                        <h6><i class="bi bi-exclamation-circle text-warning"></i> Incident Alerts</h6>
                        <p class="text-muted small">Immediate notifications for security incidents and operational issues</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="showIncidentExample()">
                            View Example
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card alert-type-card">
                    <div class="card-body">
                        <h6><i class="bi bi-shield-check text-info"></i> AML Screening Alerts</h6>
                        <p class="text-muted small">Notifications for suspicious customer matches and sanctions hits</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAMLExample()">
                            View Example
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card alert-type-card">
                    <div class="card-body">
                        <h6><i class="bi bi-file-text text-success"></i> Policy Notifications</h6>
                        <p class="text-muted small">Updates on policy approvals, changes, and compliance requirements</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="showPolicyExample()">
                            View Example
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Example Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalTitle">Alert Example</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="exampleModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load status on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadNotificationStatus();
        });

        function loadNotificationStatus() {
            fetch('/notifications/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayEmailStatus(data.data.email_service);
                        displaySMSStatus(data.data.sms_service);
                    } else {
                        showError('Failed to load notification status');
                    }
                })
                .catch(error => {
                    console.error('Error loading status:', error);
                    showError('Failed to load notification status');
                });
        }

        function displayEmailStatus(emailService) {
            const container = document.getElementById('emailStatus');
            const statusClass = emailService.configured ? 'status-active' : 'status-inactive';
            const statusText = emailService.configured ? 'Active' : 'Not Configured';
            
            container.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <span class="status-indicator ${statusClass}"></span>
                    <strong>Status: ${statusText}</strong>
                </div>
                <small class="text-muted">
                    SMTP Host: ${emailService.smtp_host || 'Not set'}<br>
                    From Email: ${emailService.from_email || 'Not set'}
                </small>
            `;
        }

        function displaySMSStatus(smsService) {
            const container = document.getElementById('smsStatus');
            const statusClass = smsService.configured ? 'status-active' : 'status-inactive';
            const statusText = smsService.configured ? 'Active' : 'Not Configured';
            
            container.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <span class="status-indicator ${statusClass}"></span>
                    <strong>Status: ${statusText}</strong>
                </div>
                <small class="text-muted">
                    Sender ID: ${smsService.sender_id || 'Not set'}<br>
                    Shortcode: ${smsService.shortcode || 'Not set'}
                </small>
            `;
        }

        function refreshStatus() {
            loadNotificationStatus();
        }

        function testNotifications() {
            const email = document.getElementById('testEmail').value.trim();
            const phone = document.getElementById('testPhone').value.trim();
            
            if (!email && !phone) {
                showTestResult('Please provide either an email address or phone number', 'danger');
                return;
            }
            
            const testData = {};
            if (email) testData.email = email;
            if (phone) testData.phone = phone;
            
            fetch('/notifications/api/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTestResult('Test notification sent successfully!', 'success');
                } else {
                    showTestResult(`Test failed: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Test error:', error);
                showTestResult('Test failed: Network error', 'danger');
            });
        }

        function sendCustomNotification() {
            const emailText = document.getElementById('emailRecipients').value.trim();
            const smsText = document.getElementById('smsRecipients').value.trim();
            const subject = document.getElementById('notificationSubject').value.trim();
            const message = document.getElementById('notificationMessage').value.trim();
            const priority = document.getElementById('notificationPriority').value;
            
            if (!subject || !message) {
                showCustomResult('Please provide subject and message', 'danger');
                return;
            }
            
            if (!emailText && !smsText) {
                showCustomResult('Please provide at least one recipient', 'danger');
                return;
            }
            
            const recipients = {};
            if (emailText) {
                recipients.email = emailText.split('\n').map(e => e.trim()).filter(e => e);
            }
            if (smsText) {
                recipients.sms = smsText.split('\n').map(s => s.trim()).filter(s => s);
            }
            
            const notificationData = {
                recipients: recipients,
                subject: subject,
                message: message,
                notification_type: 'custom',
                priority: priority
            };
            
            fetch('/notifications/api/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(notificationData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCustomResult('Custom notification sent successfully!', 'success');
                    // Clear form
                    document.getElementById('emailRecipients').value = '';
                    document.getElementById('smsRecipients').value = '';
                    document.getElementById('notificationSubject').value = '';
                    document.getElementById('notificationMessage').value = '';
                } else {
                    showCustomResult(`Failed to send notification: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Send error:', error);
                showCustomResult('Failed to send notification: Network error', 'danger');
            });
        }

        function showTestResult(message, type) {
            const result = document.getElementById('testResult');
            result.className = `test-result alert alert-${type}`;
            result.textContent = message;
            result.style.display = 'block';
            
            setTimeout(() => {
                result.style.display = 'none';
            }, 5000);
        }

        function showCustomResult(message, type) {
            const result = document.getElementById('customResult');
            result.className = `test-result alert alert-${type}`;
            result.textContent = message;
            result.style.display = 'block';
            
            setTimeout(() => {
                result.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        // Alert example functions
        function showKRIExample() {
            showAlertExample('KRI Breach Alert', `
                <h6>Email Example:</h6>
                <div class="bg-light p-3 rounded mb-3">
                    <strong>Subject:</strong> ⚠️ KRI Alert: System Downtime - CRITICAL<br><br>
                    <strong>Message:</strong><br>
                    KRI BREACH NOTIFICATION<br><br>
                    KRI Name: System Downtime<br>
                    Current Value: 4.5 hours<br>
                    Threshold: 2.0 hours<br>
                    Status: CRITICAL<br>
                    Associated Risk: IT Infrastructure Risk<br><br>
                    Please review and take appropriate action immediately.
                </div>
                <h6>SMS Example:</h6>
                <div class="bg-light p-3 rounded">
                    ⚠️ KRI ALERT: System Downtime - CRITICAL<br>
                    Value: 4.5 (Limit: 2.0)<br>
                    Risk: IT Infrastructure Risk<br>
                    Review required - NAPSA ERM
                </div>
            `);
        }

        function showIncidentExample() {
            showAlertExample('Incident Alert', `
                <h6>Email Example:</h6>
                <div class="bg-light p-3 rounded mb-3">
                    <strong>Subject:</strong> 🚨 Incident Alert: Data Breach Attempt - HIGH<br><br>
                    <strong>Message:</strong><br>
                    INCIDENT NOTIFICATION<br><br>
                    Title: Data Breach Attempt<br>
                    Severity: HIGH<br>
                    Description: Unauthorized access attempt detected on customer database<br><br>
                    Immediate attention required.
                </div>
                <h6>SMS Example:</h6>
                <div class="bg-light p-3 rounded">
                    🚨 INCIDENT: Data Breach Attempt<br>
                    Severity: HIGH<br>
                    Immediate attention required - NAPSA ERM
                </div>
            `);
        }

        function showAMLExample() {
            showAlertExample('AML Screening Alert', `
                <h6>Email Example:</h6>
                <div class="bg-light p-3 rounded mb-3">
                    <strong>Subject:</strong> 🔍 AML Alert: Sanctions Match for John Doe<br><br>
                    <strong>Message:</strong><br>
                    AML SCREENING ALERT<br><br>
                    Customer: John Doe<br>
                    Match Type: Sanctions<br>
                    Risk Score: 85.5%<br>
                    Match Details: Name match on OFAC sanctions list<br><br>
                    Please review the match and determine appropriate action.
                </div>
                <h6>SMS Example:</h6>
                <div class="bg-light p-3 rounded">
                    🔍 AML ALERT: John Doe<br>
                    Match: Sanctions (Risk: 85.5%)<br>
                    Review required - NAPSA ERM
                </div>
            `);
        }

        function showPolicyExample() {
            showAlertExample('Policy Notification', `
                <h6>Email Example:</h6>
                <div class="bg-light p-3 rounded mb-3">
                    <strong>Subject:</strong> 📋 Policy Approved: Data Protection Policy v2.1<br><br>
                    <strong>Message:</strong><br>
                    POLICY NOTIFICATION<br><br>
                    Policy: Data Protection Policy v2.1<br>
                    Action: Approved<br>
                    Approver: Risk Committee<br><br>
                    Please review the policy changes in the NAPSA ERM system.
                </div>
                <h6>SMS Example:</h6>
                <div class="bg-light p-3 rounded">
                    📋 POLICY APPROVED: Data Protection Policy v2.1<br>
                    By: Risk Committee<br>
                    Review in NAPSA ERM
                </div>
            `);
        }

        function showAlertExample(title, content) {
            document.getElementById('exampleModalTitle').textContent = title;
            document.getElementById('exampleModalBody').innerHTML = content;
            new bootstrap.Modal(document.getElementById('exampleModal')).show();
        }
    </script>
</body>
</html>