<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - NAPSA ERM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-color: #1e3a8a;
            --orange-hover: #f59e0b;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .top-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }
        
        .top-actions .btn {
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .top-actions .btn:nth-child(1) { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .top-actions .btn:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .top-actions .btn:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .top-actions .btn:nth-child(4) { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        .top-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            filter: brightness(1.1);
        }
        
        .stat-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card h2 { color: #1e293b; }
        .stat-card h6 { color: #64748b; font-weight: 600; }
        
        .stat-card .icon-gradient-1 { background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-card .icon-gradient-2 { background: var(--gradient-2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-card .icon-gradient-3 { background: var(--gradient-3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-card .icon-gradient-4 { background: var(--gradient-4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .report-card {
            transition: transform 0.2s;
            cursor: pointer;
            height: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        .template-card {
            border: 2px solid #e9ecef;
            transition: all 0.3s;
            border-radius: 0.5rem;
        }
        .template-card:hover {
            border-color: var(--sidebar-color);
            background-color: #f8f9fa;
            transform: translateY(-2px);
        }
        .schedule-item {
            border-left: 3px solid var(--sidebar-color);
            border-radius: 0.25rem;
        }
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        .nav-tabs .nav-link {
            color: #6c757d;
            border-radius: 0.375rem 0.375rem 0 0;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--sidebar-color);
            color: white;
            border-color: var(--sidebar-color);
        }
        
        .nav-tabs .nav-link:hover:not(.active) {
            color: var(--orange-hover);
            border-color: #dee2e6;
        }
        
        .btn-outline-primary {
            color: var(--sidebar-color);
            border-color: var(--sidebar-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--sidebar-color);
            border-color: var(--sidebar-color);
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Top Actions -->
        <div class="top-actions">
            <button class="btn" onclick="showGenerateModal()">
                <i class="bi bi-plus-circle"></i> Generate Report
            </button>
            <button class="btn" onclick="showScheduleModal()">
                <i class="bi bi-calendar-plus"></i> Schedule Report
            </button>
            <button class="btn" onclick="exportReports()">
                <i class="bi bi-download"></i> Export Reports
            </button>
            <button class="btn" onclick="refreshReports()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>

        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-2">Total Reports</h6>
                            <h2 class="mb-0" id="totalReports">--</h2>
                        </div>
                        <i class="bi bi-file-text fs-1 icon-gradient-1"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-2">Scheduled</h6>
                            <h2 class="mb-0" id="scheduledReports">--</h2>
                        </div>
                        <i class="bi bi-calendar-check fs-1 icon-gradient-2"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-2">Generated Today</h6>
                            <h2 class="mb-0" id="todayReports">--</h2>
                        </div>
                        <i class="bi bi-clock-history fs-1 icon-gradient-3"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-2">Templates</h6>
                            <h2 class="mb-0" id="totalTemplates">--</h2>
                        </div>
                        <i class="bi bi-file-earmark-code fs-1 icon-gradient-4"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#recent-reports">
                    <i class="bi bi-clock"></i> Recent Reports
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#templates">
                    <i class="bi bi-file-earmark-code"></i> Templates
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#scheduled">
                    <i class="bi bi-calendar3"></i> Scheduled Reports
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#history">
                    <i class="bi bi-clock-history"></i> History
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Recent Reports Tab -->
            <div class="tab-pane fade show active" id="recent-reports">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select" id="typeFilter" onchange="loadReports()">
                            <option value="all">All Types</option>
                            <option value="risk">Risk Reports</option>
                            <option value="compliance">Compliance Reports</option>
                            <option value="audit">Audit Reports</option>
                            <option value="executive">Executive Reports</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter" onchange="loadReports()">
                            <option value="all">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="generating">Generating</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchReports" 
                               placeholder="Search reports..." onkeyup="loadReports()">
                    </div>
                </div>

                <!-- Reports Grid -->
                <div class="row" id="reportsContainer">
                    <!-- Reports will be loaded here -->
                </div>
            </div>

            <!-- Templates Tab -->
            <div class="tab-pane fade" id="templates">
                <div class="row" id="templatesContainer">
                    <!-- Templates will be loaded here -->
                </div>
            </div>

            <!-- Scheduled Reports Tab -->
            <div class="tab-pane fade" id="scheduled">
                <div class="list-group" id="schedulesContainer">
                    <!-- Schedules will be loaded here -->
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-pane fade" id="history">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Report Name</th>
                                <th>Type</th>
                                <th>Generated</th>
                                <th>Generated By</th>
                                <th>Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyContainer">
                            <!-- History will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Report Modal -->
    <div class="modal fade" id="generateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generate Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="generateForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Report Template</label>
                                <select class="form-select" id="reportTemplate" onchange="loadTemplateConfig()">
                                    <option value="">Select Template</option>
                                    <option value="risk-assessment">Risk Assessment Report</option>
                                    <option value="compliance-status">Compliance Status Report</option>
                                    <option value="executive-summary">Executive Summary</option>
                                    <option value="audit-findings">Audit Findings Report</option>
                                    <option value="vendor-performance">Vendor Performance Report</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Format</label>
                                <select class="form-select" id="reportFormat">
                                    <option value="pdf">PDF</option>
                                    <option value="excel">Excel</option>
                                    <option value="csv">CSV</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date Range</label>
                                <select class="form-select" id="dateRange" onchange="toggleCustomDates()">
                                    <option value="last-30">Last 30 Days</option>
                                    <option value="last-quarter">Last Quarter</option>
                                    <option value="ytd">Year to Date</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Department</label>
                                <select class="form-select" id="department">
                                    <option value="all">All Departments</option>
                                    <option value="it">IT</option>
                                    <option value="finance">Finance</option>
                                    <option value="operations">Operations</option>
                                    <option value="compliance">Compliance</option>
                                </select>
                            </div>
                        </div>
                        <div class="row d-none" id="customDatesRow">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Report Name</label>
                            <input type="text" class="form-control" id="reportName" 
                                   placeholder="Enter report name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="reportDescription" rows="2"
                                      placeholder="Enter report description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Recipients (comma-separated emails)</label>
                            <input type="text" class="form-control" id="recipients" 
                                   placeholder="john@napsa.co.zm, jane@napsa.co.zm">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="generateReport()">
                        <i class="bi bi-file-earmark-arrow-down"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Report Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Schedule Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Report Template</label>
                                <select class="form-select" id="scheduleTemplate">
                                    <option value="">Select Template</option>
                                    <option value="risk-assessment">Risk Assessment Report</option>
                                    <option value="compliance-status">Compliance Status Report</option>
                                    <option value="executive-summary">Executive Summary</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Frequency</label>
                                <select class="form-select" id="scheduleFrequency" onchange="updateScheduleOptions()">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3 d-none" id="dayOfWeekRow">
                                <label class="form-label">Day of Week</label>
                                <select class="form-select" id="dayOfWeek">
                                    <option value="monday">Monday</option>
                                    <option value="tuesday">Tuesday</option>
                                    <option value="wednesday">Wednesday</option>
                                    <option value="thursday">Thursday</option>
                                    <option value="friday">Friday</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3 d-none" id="dayOfMonthRow">
                                <label class="form-label">Day of Month</label>
                                <input type="number" class="form-control" id="dayOfMonth" min="1" max="31" value="1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Time</label>
                                <input type="time" class="form-control" id="scheduleTime" value="08:00">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Recipients</label>
                            <input type="text" class="form-control" id="scheduleRecipients" 
                                   placeholder="Enter email addresses">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="scheduleReport()">
                        <i class="bi bi-calendar-plus"></i> Schedule Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            loadReports();
            loadTemplates();
            loadSchedules();
            loadHistory();
        });

        function loadDashboard() {
            fetch('/reports/api/reports/dashboard')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalReports').textContent = data.data.summary.total_reports || '0';
                        document.getElementById('scheduledReports').textContent = data.data.summary.scheduled_reports || '0';
                        document.getElementById('todayReports').textContent = data.data.summary.generated_today || '0';
                        document.getElementById('totalTemplates').textContent = data.data.summary.total_templates || '0';
                    }
                })
                .catch(error => console.error('Error loading dashboard:', error));
        }

        function loadReports() {
            const type = document.getElementById('typeFilter').value;
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchReports').value;
            
            fetch(`/reports/api/reports?type=${type}&status=${status}&search=${search}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayReports(data.data.reports);
                    }
                })
                .catch(error => console.error('Error loading reports:', error));
        }

        function displayReports(reports) {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '';
            
            if (!reports || reports.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-center text-muted">No reports found</p></div>';
                return;
            }
            
            reports.forEach(report => {
                const statusClass = report.status === 'completed' ? 'success' : 
                                  report.status === 'generating' ? 'warning' : 'danger';
                
                const card = `
                    <div class="col-md-4 mb-3">
                        <div class="card report-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title">${report.name}</h6>
                                    <span class="badge bg-${statusClass} status-badge">${report.status}</span>
                                </div>
                                <p class="card-text small text-muted">${report.description || 'No description'}</p>
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> ${new Date(report.created_date).toLocaleDateString()}
                                        <br>
                                        <i class="bi bi-file-earmark"></i> ${report.format.toUpperCase()}
                                        ${report.file_size ? `| ${report.file_size}` : ''}
                                    </small>
                                </div>
                                ${report.status === 'generating' ? `
                                    <div class="progress mb-2">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             style="width: ${report.progress || 0}%"></div>
                                    </div>
                                ` : ''}
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    ${report.status === 'completed' ? `
                                        <button class="btn btn-outline-primary" onclick="viewReport('${report.id}')">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                        <button class="btn btn-outline-success" onclick="downloadReport('${report.id}', '${report.format}')">
                                            <i class="bi bi-download"></i> Download
                                        </button>
                                        <button class="btn btn-outline-info" onclick="shareReport('${report.id}')">
                                            <i class="bi bi-share"></i> Share
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        function loadTemplates() {
            fetch('/reports/api/reports/templates')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayTemplates(data.data.templates);
                    }
                })
                .catch(error => console.error('Error loading templates:', error));
        }

        function displayTemplates(templates) {
            const container = document.getElementById('templatesContainer');
            container.innerHTML = '';
            
            if (!templates || templates.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-center text-muted">No templates available</p></div>';
                return;
            }
            
            templates.forEach(template => {
                const card = `
                    <div class="col-md-4 mb-3">
                        <div class="card template-card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="bi bi-file-earmark-code text-primary"></i> ${template.name}
                                </h5>
                                <p class="card-text">${template.description}</p>
                                <div class="mb-3">
                                    <small class="text-muted">
                                        Category: ${template.category}<br>
                                        Last Updated: ${new Date(template.updated_date).toLocaleDateString()}
                                    </small>
                                </div>
                                <button class="btn btn-primary btn-sm w-100" 
                                        onclick="useTemplate('${template.id}')">
                                    Use Template
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        function loadSchedules() {
            fetch('/reports/api/reports/schedules')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySchedules(data.data.schedules);
                    }
                })
                .catch(error => console.error('Error loading schedules:', error));
        }

        function displaySchedules(schedules) {
            const container = document.getElementById('schedulesContainer');
            container.innerHTML = '';
            
            if (!schedules || schedules.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No scheduled reports</p>';
                return;
            }
            
            schedules.forEach(schedule => {
                const item = `
                    <div class="list-group-item schedule-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${schedule.report_name}</h6>
                            <div>
                                <div class="form-check form-switch d-inline-block">
                                    <input class="form-check-input" type="checkbox" 
                                           ${schedule.enabled ? 'checked' : ''}
                                           onchange="toggleSchedule('${schedule.id}', this.checked)">
                                </div>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteSchedule('${schedule.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="mb-1">
                            <span class="badge bg-primary">${schedule.frequency}</span>
                            <small class="text-muted">at ${schedule.time}</small>
                        </p>
                        <small class="text-muted">
                            Next Run: ${new Date(schedule.next_run).toLocaleString()}<br>
                            Recipients: ${schedule.recipients.join(', ')}
                        </small>
                    </div>
                `;
                container.innerHTML += item;
            });
        }

        function loadHistory() {
            fetch('/reports/api/reports/history')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayHistory(data.data.history);
                    }
                })
                .catch(error => console.error('Error loading history:', error));
        }

        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            container.innerHTML = '';
            
            if (!history || history.length === 0) {
                container.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No history available</td></tr>';
                return;
            }
            
            history.forEach(item => {
                const row = `
                    <tr>
                        <td>${item.name}</td>
                        <td><span class="badge bg-secondary">${item.type}</span></td>
                        <td>${new Date(item.generated_date).toLocaleString()}</td>
                        <td>${item.generated_by}</td>
                        <td>${item.file_size}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="downloadReport('${item.id}', '${item.format}')">
                                <i class="bi bi-download"></i>
                            </button>
                        </td>
                    </tr>
                `;
                container.innerHTML += row;
            });
        }

        function showGenerateModal() {
            const modal = new bootstrap.Modal(document.getElementById('generateModal'));
            modal.show();
        }

        function showScheduleModal() {
            const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
            modal.show();
        }

        function generateReport() {
            const reportData = {
                name: document.getElementById('reportName').value,
                type: document.getElementById('reportTemplate').value,
                format: document.getElementById('reportFormat').value,
                description: document.getElementById('reportDescription').value,
                recipients: document.getElementById('recipients').value.split(',').map(e => e.trim()).filter(e => e),
                parameters: {
                    date_range: document.getElementById('dateRange').value,
                    department: document.getElementById('department').value
                }
            };
            
            fetch('/reports/api/reports/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(reportData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Report generated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('generateModal')).hide();
                    loadReports();
                    loadDashboard();
                } else {
                    alert('Error generating report: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error generating report');
            });
        }

        function downloadReport(reportId, format) {
            window.location.href = `/reports/api/reports/${reportId}/download?format=${format}`;
        }

        function viewReport(reportId) {
            // In a real implementation, this would open a report viewer
            window.open(`/reports/api/reports/${reportId}/download?format=pdf`, '_blank');
        }

        function shareReport(reportId) {
            const recipients = prompt('Enter recipient emails (comma-separated):');
            if (recipients) {
                fetch(`/reports/api/reports/${reportId}/share`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        recipients: recipients.split(',').map(e => e.trim())
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                    }
                });
            }
        }

        function scheduleReport() {
            const scheduleData = {
                report_id: document.getElementById('scheduleTemplate').value,
                frequency: document.getElementById('scheduleFrequency').value,
                time: document.getElementById('scheduleTime').value,
                recipients: document.getElementById('scheduleRecipients').value.split(',').map(e => e.trim()).filter(e => e)
            };
            
            if (scheduleData.frequency === 'weekly') {
                scheduleData.day_of_week = document.getElementById('dayOfWeek').value;
            } else if (scheduleData.frequency === 'monthly') {
                scheduleData.day_of_month = document.getElementById('dayOfMonth').value;
            }
            
            fetch(`/reports/api/reports/${scheduleData.report_id}/schedule`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(scheduleData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Report scheduled successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                    loadSchedules();
                    loadDashboard();
                }
            });
        }

        function updateScheduleOptions() {
            const frequency = document.getElementById('scheduleFrequency').value;
            const dayOfWeekRow = document.getElementById('dayOfWeekRow');
            const dayOfMonthRow = document.getElementById('dayOfMonthRow');
            
            dayOfWeekRow.classList.add('d-none');
            dayOfMonthRow.classList.add('d-none');
            
            if (frequency === 'weekly') {
                dayOfWeekRow.classList.remove('d-none');
            } else if (frequency === 'monthly') {
                dayOfMonthRow.classList.remove('d-none');
            }
        }

        function toggleCustomDates() {
            const dateRange = document.getElementById('dateRange').value;
            const customDatesRow = document.getElementById('customDatesRow');
            
            if (dateRange === 'custom') {
                customDatesRow.classList.remove('d-none');
            } else {
                customDatesRow.classList.add('d-none');
            }
        }

        function toggleSchedule(scheduleId, enabled) {
            fetch(`/reports/api/reports/schedules/${scheduleId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled: enabled})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Schedule updated');
                }
            });
        }

        function deleteSchedule(scheduleId) {
            if (confirm('Are you sure you want to delete this schedule?')) {
                fetch(`/reports/api/reports/schedules/${scheduleId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadSchedules();
                        loadDashboard();
                    }
                });
            }
        }

        function useTemplate(templateId) {
            showGenerateModal();
            document.getElementById('reportTemplate').value = templateId;
        }

        function loadTemplateConfig() {
            // Load template-specific configuration
            const template = document.getElementById('reportTemplate').value;
            if (template) {
                document.getElementById('reportName').value = template.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
        }
        
        function exportReports() {
            console.log('Exporting reports...');
            alert('Reports export initiated');
        }
        
        function refreshReports() {
            loadDashboard();
            loadReports();
            loadTemplates();
            loadSchedules();
            loadHistory();
            console.log('Reports refreshed');
        }
    </script>
</body>
</html>