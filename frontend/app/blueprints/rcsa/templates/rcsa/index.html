{% extends "layouts/base.html" %}

{% block title %}RCSA Management - NAPSA ERM{% endblock %}

{% block styles %}
<style>
    :root {
        --primary-color: #1e3a8a;
        --secondary-color: #f59e0b;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --info-color: #3b82f6;
        --dark-color: #1f2937;
        --light-color: #f9fafb;
        --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    body {
        background: #f0f2f5;
        min-height: 100vh;
    }

    .content-wrapper {
        padding: 2rem;
    }

    /* Dashboard Header */
    .dashboard-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #3b82f6 100%);
        color: white;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(30, 58, 138, 0.2);
    }

    .dashboard-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .dashboard-header p {
        opacity: 0.9;
        margin-bottom: 0;
    }

    /* Action Buttons */
    .action-buttons {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .btn-primary {
        background: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
        color: white !important;
        padding: 0.625rem 1.5rem;
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(30, 58, 138, 0.15);
    }

    .btn-primary:hover {
        background: #2563eb !important;
        border-color: #2563eb !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(30, 58, 138, 0.25);
    }

    .btn-secondary {
        background: white !important;
        border: 2px solid #e5e7eb !important;
        color: var(--dark-color) !important;
        padding: 0.625rem 1.5rem;
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background: var(--light-color) !important;
        border-color: var(--primary-color) !important;
        color: var(--primary-color) !important;
        transform: translateY(-2px);
    }

    /* Statistics Cards */
    .stat-card {
        background: white;
        border-radius: 20px;
        padding: 1.75rem;
        height: 100%;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .stat-card.total::before { background: var(--gradient-1); }
    .stat-card.pending::before { background: var(--gradient-2); }
    .stat-card.progress::before { background: var(--gradient-3); }
    .stat-card.completed::before { background: var(--gradient-4); }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-icon.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .stat-icon.pending { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .stat-icon.progress { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
    .stat-icon.completed { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-change {
        display: inline-flex;
        align-items: center;
        margin-top: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .stat-change.positive {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .stat-change.negative {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    /* Filter Section */
    .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .form-select, .form-control {
        border-radius: 10px;
        border: 1.5px solid #e5e7eb;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
    }

    /* Table Card */
    .table-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .table-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-bottom: 2px solid #e5e7eb;
        padding: 1.5rem;
    }

    .table-card .card-header h5 {
        margin: 0;
        color: var(--dark-color);
        font-weight: 600;
    }

    /* Status Badges */
    .status-badge {
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.pending {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .status-badge.in-progress {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .status-badge.completed {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .status-badge.overdue {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    /* Charts Section */
    .chart-card {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }

    .chart-card h5 {
        color: var(--dark-color);
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    /* Upcoming Assessments */
    .upcoming-card {
        background: white;
        border-radius: 15px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }

    .upcoming-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .upcoming-card.urgent { border-left-color: #ef4444; }
    .upcoming-card.warning { border-left-color: #f59e0b; }
    .upcoming-card.normal { border-left-color: #3b82f6; }

    /* Animations */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in {
        animation: slideInUp 0.5s ease-out;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header {
            padding: 1.5rem;
        }
        
        .stat-card {
            margin-bottom: 1rem;
        }
        
        .content-wrapper {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Dashboard Header -->
    <div class="dashboard-header animate-slide-in">
        <h1><i class="bi bi-shield-check me-2"></i>RCSA Management Dashboard</h1>
        <p>Risk Control Self Assessment - Monitor, track and manage assessments across all departments</p>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons animate-slide-in">
        <div class="row align-items-center">
            <div class="col-md-8">
                <button class="btn btn-primary" onclick="showCreateModal()">
                    <i class="bi bi-plus-circle me-2"></i>New Assessment
                </button>
                <button class="btn btn-secondary ms-2" onclick="createBulkRCSAs()">
                    <i class="bi bi-calendar-plus me-2"></i>Bulk Schedule
                </button>
                <button class="btn btn-secondary ms-2" onclick="loadRCSAs()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                </button>
                <button class="btn btn-secondary ms-2" onclick="exportRCSAs()">
                    <i class="bi bi-download me-2"></i>Export Report
                </button>
            </div>
            <div class="col-md-4 text-end">
                <span class="text-muted">Last updated: <span id="lastUpdated">Just now</span></span>
            </div>
        </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="row mb-4" id="dashboardStats">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card total animate-slide-in">
                <div class="stat-icon total">
                    <i class="bi bi-clipboard-data"></i>
                </div>
                <div class="stat-value" id="totalAssessments">0</div>
                <div class="stat-label">Total Assessments</div>
                <span class="stat-change positive">
                    <i class="bi bi-arrow-up me-1"></i>12% from last month
                </span>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card pending animate-slide-in">
                <div class="stat-icon pending">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stat-value" id="pendingAssessments">0</div>
                <div class="stat-label">Pending</div>
                <span class="stat-change negative">
                    <i class="bi bi-arrow-down me-1"></i>3% from last week
                </span>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card progress animate-slide-in">
                <div class="stat-icon progress">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stat-value" id="inProgressAssessments">0</div>
                <div class="stat-label">In Progress</div>
                <span class="stat-change positive">
                    <i class="bi bi-arrow-up me-1"></i>5% from last week
                </span>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card completed animate-slide-in">
                <div class="stat-icon completed">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-value" id="completedAssessments">0</div>
                <div class="stat-label">Completed</div>
                <span class="stat-change positive">
                    <i class="bi bi-arrow-up me-1"></i>8% from last month
                </span>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="chart-card animate-slide-in">
                <h5><i class="bi bi-graph-up me-2"></i>Assessment Trends</h5>
                <canvas id="trendsChart" height="80"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-card animate-slide-in">
                <h5><i class="bi bi-pie-chart me-2"></i>Status Distribution</h5>
                <canvas id="statusChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filter-section animate-slide-in">
        <div class="row">
            <div class="col-md-3 mb-2">
                <label class="form-label small text-muted">Status Filter</label>
                <select class="form-select" id="statusFilter" onchange="loadRCSAs()">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="overdue">Overdue</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label small text-muted">Department</label>
                <select class="form-select" id="departmentFilter" onchange="loadRCSAs()">
                    <option value="">All Departments</option>
                    <option value="Information Technology">Information Technology</option>
                    <option value="Finance">Finance</option>
                    <option value="Human Resources">Human Resources</option>
                    <option value="Operations">Operations</option>
                    <option value="Legal & Compliance">Legal & Compliance</option>
                    <option value="Risk Management">Risk Management</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label small text-muted">Assessment Type</label>
                <select class="form-select" id="typeFilter" onchange="loadRCSAs()">
                    <option value="">All Types</option>
                    <option value="annual">Annual</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="monthly">Monthly</option>
                    <option value="adhoc">Ad-hoc</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label class="form-label small text-muted">Search</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchBox" placeholder="Search assessments..." onkeyup="filterRCSAs()">
                </div>
            </div>
        </div>
    </div>

    <!-- RCSA List -->
    <div class="table-card animate-slide-in">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5><i class="bi bi-list-check me-2"></i>RCSA Assessments</h5>
                </div>
                <div class="col-md-6 text-end">
                    <span class="badge bg-primary" id="totalCount">0 Total</span>
                </div>
            </div>
        </div>
        <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="rcsaTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Department</th>
                                <th>Type</th>
                                <th>Assigned To</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rcsaTableBody">
                            <!-- RCSAs will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    <!-- Upcoming Assessments -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-card animate-slide-in">
                <div class="row align-items-center mb-3">
                    <div class="col-md-6">
                        <h5><i class="bi bi-calendar-week me-2"></i>Upcoming Assessments</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <span class="text-muted">Next 30 days</span>
                    </div>
                </div>
                <div id="upcomingAssessments">
                    <!-- Upcoming assessments will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create/Edit RCSA Modal -->
    <div class="modal fade" id="rcsaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Create RCSA Assessment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="rcsaForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Title *</label>
                                    <input type="text" class="form-control" id="rcsaTitle" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Assessment Type</label>
                                    <select class="form-select" id="assessmentType">
                                        <option value="annual">Annual</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="adhoc">Ad-hoc</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Department *</label>
                                    <select class="form-select" id="department" required>
                                        <option value="">Select Department</option>
                                        <option value="Information Technology">Information Technology</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Human Resources">Human Resources</option>
                                        <option value="Operations">Operations</option>
                                        <option value="Legal">Legal</option>
                                        <option value="Audit">Internal Audit</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Business Unit</label>
                                    <input type="text" class="form-control" id="businessUnit">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Risk Category</label>
                                    <select class="form-select" id="riskCategory">
                                        <option value="Operational">Operational</option>
                                        <option value="Financial">Financial</option>
                                        <option value="Strategic">Strategic</option>
                                        <option value="Compliance">Compliance</option>
                                        <option value="Cyber Security">Cyber Security</option>
                                        <option value="Reputational">Reputational</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Assigned To *</label>
                                    <select class="form-control" id="assignedTo" required>
                                        <option value="">Select User</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Scheduled Date *</label>
                                    <input type="date" class="form-control" id="scheduledDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Due Date *</label>
                                    <input type="date" class="form-control" id="dueDate" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRCSA()">Save RCSA</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
        let currentRCSAId = null;

        let trendsChart = null;
        let statusChart = null;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadRCSAs();
            loadUpcomingAssessments();
            loadUsers();
            initializeCharts();
            updateLastUpdatedTime();
        });

        function loadDashboardStats() {
            fetch('/rcsa/api/dashboard/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayDashboardStats(data.data);
                    }
                })
                .catch(error => console.error('Error loading dashboard stats:', error));
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdated').textContent = timeString;
        }

        function displayDashboardStats(stats) {
            // Update stat cards
            document.getElementById('totalAssessments').textContent = stats.total_rcsas || 0;
            document.getElementById('pendingAssessments').textContent = stats.pending_assessments || 0;
            document.getElementById('inProgressAssessments').textContent = stats.in_progress_assessments || 0;
            document.getElementById('completedAssessments').textContent = stats.completed_assessments || 0;
            
            // Update charts
            updateCharts(stats);
        }

        function initializeCharts() {
            // Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Completed',
                        data: [12, 19, 15, 25, 22, 30],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Created',
                        data: [15, 22, 18, 28, 25, 32],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Status Distribution Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'In Progress', 'Completed', 'Overdue'],
                    datasets: [{
                        data: [30, 25, 35, 10],
                        backgroundColor: [
                            '#f59e0b',
                            '#3b82f6',
                            '#10b981',
                            '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateCharts(stats) {
            if (statusChart && stats) {
                statusChart.data.datasets[0].data = [
                    stats.pending_assessments || 0,
                    stats.in_progress_assessments || 0,
                    stats.completed_assessments || 0,
                    stats.overdue_assessments || 0
                ];
                statusChart.update();
            }
        }

        function loadRCSAs() {
            const status = document.getElementById('statusFilter').value;
            const department = document.getElementById('departmentFilter').value;
            
            let url = '/rcsa/api/rcsas?';
            if (status) url += `status=${status}&`;
            if (department) url += `department=${encodeURIComponent(department)}&`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayRCSAs(data.data);
                        document.getElementById('totalCount').textContent = `${data.data.length} Total`;
                    }
                })
                .catch(error => console.error('Error loading RCSAs:', error));
        }

        function displayRCSAs(rcsas) {
            const tbody = document.getElementById('rcsaTableBody');
            tbody.innerHTML = '';
            
            rcsas.forEach(rcsa => {
                const row = tbody.insertRow();
                const dueDate = new Date(rcsa.due_date);
                const today = new Date();
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let statusBadge = `<span class="badge bg-secondary status-badge">${rcsa.status}</span>`;
                if (rcsa.status === 'completed') statusBadge = `<span class="badge bg-success status-badge">${rcsa.status}</span>`;
                if (rcsa.status === 'in_progress') statusBadge = `<span class="badge bg-primary status-badge">${rcsa.status}</span>`;
                if (rcsa.status === 'overdue') statusBadge = `<span class="badge bg-danger status-badge">${rcsa.status}</span>`;
                
                let dueDateClass = '';
                if (daysDiff <= 7 && daysDiff > 0) dueDateClass = 'due-soon';
                if (daysDiff < 0) dueDateClass = 'overdue';
                
                row.innerHTML = `
                    <td>${rcsa.title}</td>
                    <td>${rcsa.department}</td>
                    <td><span class="badge bg-light text-dark">${rcsa.assessment_type}</span></td>
                    <td>${rcsa.assigned_to}</td>
                    <td class="${dueDateClass}">${new Date(rcsa.due_date).toLocaleDateString()}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editRCSA('${rcsa.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRCSA('${rcsa.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        function loadUpcomingAssessments() {
            fetch('/rcsa/api/upcoming?days=30')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayUpcomingAssessments(data.data);
                    }
                })
                .catch(error => console.error('Error loading upcoming assessments:', error));
        }

        function loadUsers() {
            fetch('/rcsa/api/users')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('assignedTo');
                        select.innerHTML = '<option value="">Select User</option>';
                        
                        data.data.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.email || user.id;
                            option.textContent = user.name || user.email || `User ${user.id}`;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    // Add some default options if loading fails - Zambian names with roles
                    const select = document.getElementById('assignedTo');
                    select.innerHTML = `
                        <option value="">Select User</option>
                        <option value="mutale.mwansa@napsa.co.zm">Mutale Mwansa - Risk Manager</option>
                        <option value="chanda.bwalya@napsa.co.zm">Chanda Bwalya - Senior Risk Analyst</option>
                        <option value="mulenga.banda@napsa.co.zm">Mulenga Banda - Compliance Officer</option>
                        <option value="temba.zulu@napsa.co.zm">Temba Zulu - Risk Analyst</option>
                        <option value="natasha.phiri@napsa.co.zm">Natasha Phiri - Risk Assessment Lead</option>
                    `;
                });
        }

        function displayUpcomingAssessments(assessments) {
            const container = document.getElementById('upcomingAssessments');
            
            if (assessments.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3">No upcoming assessments in the next 30 days.</p>';
                return;
            }
            
            let html = '';
            assessments.slice(0, 6).forEach(rcsa => {
                const daysUntilDue = rcsa.days_until_due;
                let urgencyClass = 'normal';
                let badgeClass = 'bg-info';
                
                if (daysUntilDue <= 0) {
                    urgencyClass = 'urgent';
                    badgeClass = 'bg-danger';
                } else if (daysUntilDue <= 3) {
                    urgencyClass = 'urgent';
                    badgeClass = 'bg-danger';
                } else if (daysUntilDue <= 7) {
                    urgencyClass = 'warning';
                    badgeClass = 'bg-warning';
                }
                
                html += `
                    <div class="upcoming-card ${urgencyClass}">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${rcsa.title}</h6>
                                <p class="text-muted small mb-0">
                                    <i class="bi bi-building me-1"></i>${rcsa.department} | 
                                    <i class="bi bi-person me-1"></i>${rcsa.assigned_to || 'Unassigned'}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge ${badgeClass}">
                                    ${daysUntilDue >= 0 ? daysUntilDue + ' days' : 'Overdue by ' + Math.abs(daysUntilDue) + ' days'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showCreateModal() {
            currentRCSAId = null;
            document.getElementById('modalTitle').textContent = 'Create RCSA Assessment';
            document.getElementById('rcsaForm').reset();
            loadUsers(); // Ensure users are loaded
            new bootstrap.Modal(document.getElementById('rcsaModal')).show();
        }

        function editRCSA(rcsaId) {
            currentRCSAId = rcsaId;
            document.getElementById('modalTitle').textContent = 'Edit RCSA Assessment';
            loadUsers(); // Ensure users are loaded
            // TODO: Load RCSA data and populate form
            new bootstrap.Modal(document.getElementById('rcsaModal')).show();
        }

        function saveRCSA() {
            const formData = {
                title: document.getElementById('rcsaTitle').value,
                description: document.getElementById('description').value,
                department: document.getElementById('department').value,
                business_unit: document.getElementById('businessUnit').value,
                risk_category: document.getElementById('riskCategory').value,
                assessment_type: document.getElementById('assessmentType').value,
                scheduled_date: document.getElementById('scheduledDate').value,
                due_date: document.getElementById('dueDate').value,
                assigned_to: document.getElementById('assignedTo').value
            };
            
            const url = currentRCSAId ? `/rcsa/api/rcsa/${currentRCSAId}` : '/rcsa/api/rcsa';
            const method = currentRCSAId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    bootstrap.Modal.getInstance(document.getElementById('rcsaModal')).hide();
                    loadRCSAs();
                    loadDashboardStats();
                    loadUpcomingAssessments();
                    alert('RCSA assessment saved successfully!');
                } else {
                    alert('Error saving RCSA: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving RCSA:', error);
                alert('Error saving RCSA assessment');
            });
        }

        function deleteRCSA(rcsaId) {
            if (confirm('Are you sure you want to delete this RCSA assessment?')) {
                fetch(`/rcsa/api/rcsa/${rcsaId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        loadRCSAs();
                        loadDashboardStats();
                        loadUpcomingAssessments();
                        alert('RCSA assessment deleted successfully!');
                    } else {
                        alert('Error deleting RCSA: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting RCSA:', error);
                    alert('Error deleting RCSA assessment');
                });
            }
        }

        function createBulkRCSAs() {
            // TODO: Implement bulk RCSA creation
            alert('Bulk RCSA scheduling will be implemented based on your specific requirements.');
        }

        function filterRCSAs() {
            // TODO: Implement client-side filtering
            loadRCSAs();
        }

        // Export RCSAs
        function exportRCSAs() {
            console.log('Exporting RCSAs...');
            // Implementation for exporting RCSAs
            alert('RCSA export initiated');
        }
</script>
{% endblock %}