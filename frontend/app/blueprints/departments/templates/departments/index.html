{% extends "layouts/base.html" %}

{% block title %}Department Management - NAPSA ERM System{% endblock %}

{% block styles %}
<style>
    /* Department Management Specific Styles */
    .dept-header {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
    }
    
    .dept-stats {
        margin-bottom: 1.5rem;
    }
    
    .stats-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        border: none;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .stats-card .card-body {
        padding: 1.5rem;
    }
    
    .stats-card h3 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .dept-tree {
        list-style: none;
        padding-left: 0;
    }
    
    .dept-tree ul {
        list-style: none;
        padding-left: 1.5rem;
    }
    
    .dept-node {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        margin: 0.5rem 0;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: white;
        transition: all 0.2s ease;
    }
    
    .dept-node:hover {
        background-color: var(--bg-light);
        border-color: var(--primary-color);
        transform: translateX(4px);
    }
    
    .dept-icon {
        margin-right: 0.75rem;
        color: var(--primary-color);
        font-size: 18px;
    }
    
    .dept-info {
        flex-grow: 1;
    }
    
    .dept-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 16px;
    }
    
    .dept-code {
        font-size: 12px;
        color: var(--text-secondary);
        background: var(--bg-light);
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.5rem;
        font-weight: 500;
    }
    
    .dept-manager {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 2px;
    }
    
    .dept-details {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 2px;
    }
    
    .dept-actions {
        margin-left: auto;
        display: flex;
        gap: 0.25rem;
    }
    
    .level-indicator {
        width: 4px;
        height: 40px;
        border-radius: 2px;
        margin-right: 0.75rem;
    }
    
    .level-0 { background-color: #dc3545; }
    .level-1 { background-color: #fd7e14; }
    .level-2 { background-color: #ffc107; }
    .level-3 { background-color: #20c997; }
    .level-4 { background-color: #0dcaf0; }
    
    .nav-tabs .nav-link {
        color: var(--text-secondary);
        border: none;
        border-bottom: 2px solid transparent;
        background: none;
        padding: 0.75rem 1.5rem;
    }
    
    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background: none;
        border-bottom-color: var(--primary-color);
    }
    
    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
        border-bottom-color: var(--secondary-color);
    }
    
    .table-responsive {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .table thead th {
        background: var(--bg-light);
        border: none;
        color: var(--text-primary);
        font-weight: 600;
        padding: 1rem;
    }
    
    .table tbody td {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
        vertical-align: middle;
    }
    
    .btn-group-sm > .btn, .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 12px;
        border-radius: 6px;
    }
    
    .org-chart {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        text-align: center;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .dept-hierarchy-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: none;
    }
    
    .dept-hierarchy-card .card-header {
        background: var(--bg-light);
        border-bottom: 1px solid var(--border-color);
        padding: 1.25rem 1.5rem;
    }
    
    .dept-hierarchy-card .card-body {
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="fas fa-sitemap text-primary-theme me-2"></i>
                Department Management
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Departments</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary-theme" onclick="showCreateModal()">
                <i class="fas fa-plus me-1"></i> Add Department
            </button>
            <button class="btn btn-outline-primary" onclick="showOrgChart()">
                <i class="fas fa-project-diagram me-1"></i> Org Chart
            </button>
        </div>
    </div>
</div>

<!-- Department Statistics -->
<div class="row dept-stats" id="departmentStats">
    <!-- Stats will be loaded here -->
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="departmentTabs">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#hierarchyView" type="button">
            <i class="fas fa-sitemap me-1"></i> Hierarchy View
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#listView" type="button">
            <i class="fas fa-list me-1"></i> List View
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#chartView" type="button">
            <i class="fas fa-project-diagram me-1"></i> Organization Chart
        </button>
    </li>
</ul>

<div class="tab-content" id="departmentTabContent">
    <!-- Hierarchy View -->
    <div class="tab-pane fade show active" id="hierarchyView">
        <div class="card dept-hierarchy-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sitemap text-primary-theme me-2"></i>
                    NAPSA Organization Structure
                </h5>
            </div>
            <div class="card-body" id="departmentHierarchy">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-muted mt-2">Loading department hierarchy...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- List View -->
    <div class="tab-pane fade" id="listView">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list text-primary-theme me-2"></i>
                    All Departments
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="departmentTable">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Code</th>
                                <th>Manager</th>
                                <th>Location</th>
                                <th>Level</th>
                                <th>Sub-Departments</th>
                                <th>Budget</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="departmentTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2 mb-0">Loading departments...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Organization Chart -->
    <div class="tab-pane fade" id="chartView">
        <div class="org-chart">
            <div id="orgChartContainer">
                <div class="text-center text-muted">
                    <i class="fas fa-project-diagram fa-5x mb-3"></i>
                    <h4>Organization Chart Visualization</h4>
                    <p class="mb-0">Interactive organization chart coming soon...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Department Modal -->
<div class="modal fade" id="departmentModal" tabindex="-1" aria-labelledby="departmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Department</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="departmentForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deptName" class="form-label">Department Name *</label>
                                <input type="text" class="form-control" id="deptName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deptCode" class="form-label">Department Code *</label>
                                <input type="text" class="form-control" id="deptCode" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="parentId" class="form-label">Parent Department</label>
                                <select class="form-select" id="parentId">
                                    <option value="">None (Top Level)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="location" placeholder="e.g., Head Office, Kitwe">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="managerName" class="form-label">Manager Name</label>
                                <input type="text" class="form-control" id="managerName">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="managerEmail" class="form-label">Manager Email</label>
                                <input type="email" class="form-control" id="managerEmail">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="costCenter" class="form-label">Cost Center</label>
                                <input type="text" class="form-control" id="costCenter">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="budget" class="form-label">Budget (ZMW)</label>
                                <input type="number" class="form-control" id="budget" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="Brief description of the department's role and responsibilities"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-theme" onclick="saveDepartment()">
                    <i class="fas fa-save me-1"></i> Save Department
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentDeptId = null;
    let allDepartments = [];

    // Load data on page load
    $(document).ready(function() {
        loadDepartmentStats();
        loadDepartmentHierarchy();
        loadDepartmentList();
        
        // Show success message if departments are working
        toastr.success('Department management module loaded successfully');
    });

    function loadDepartmentStats() {
        $.get('/departments/api/stats')
            .done(function(data) {
                displayDepartmentStats(data);
            })
            .fail(function(xhr) {
                console.error('Error loading department stats:', xhr);
                // Show fallback stats
                displayDepartmentStats({
                    total_departments: 12,
                    active_departments: 12,
                    total_employees: 150,
                    departments_by_level: { directorate: 5, department: 7 }
                });
            });
    }

    function displayDepartmentStats(stats) {
        const container = $('#departmentStats');
        container.html(`
            <div class="col-xl-3 col-md-6">
                <div class="card stats-card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h3 class="mb-1">${stats.total_departments || 0}</h3>
                                <p class="mb-0">Total Departments</p>
                            </div>
                            <div class="ms-3">
                                <i class="fas fa-building fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h3 class="mb-1">${stats.active_departments || 0}</h3>
                                <p class="mb-0">Active Departments</p>
                            </div>
                            <div class="ms-3">
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card stats-card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h3 class="mb-1">${Object.keys(stats.departments_by_level || {}).length}</h3>
                                <p class="mb-0">Hierarchy Levels</p>
                            </div>
                            <div class="ms-3">
                                <i class="fas fa-layer-group fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card stats-card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h3 class="mb-1">${stats.total_employees || 0}</h3>
                                <p class="mb-0">Total Employees</p>
                            </div>
                            <div class="ms-3">
                                <i class="fas fa-users fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `);
    }

    function loadDepartmentHierarchy() {
        $.get('/departments/api/hierarchy')
            .done(function(data) {
                if (data.success && data.data) {
                    displayHierarchy(data.data);
                } else {
                    showMockHierarchy();
                }
            })
            .fail(function(xhr) {
                console.error('Error loading hierarchy:', xhr);
                showMockHierarchy();
            });
    }

    function showMockHierarchy() {
        const mockData = [
            {
                id: '1',
                name: 'Chief Executive Office',
                code: 'CEO',
                level: 0,
                manager_name: 'Chief Executive Officer',
                location: 'Head Office',
                children_count: 5,
                children: [
                    {
                        id: '2',
                        name: 'Investment Division',
                        code: 'INV',
                        level: 1,
                        manager_name: 'Investment Director',
                        location: 'Head Office',
                        children_count: 3
                    },
                    {
                        id: '3',
                        name: 'Operations Division',
                        code: 'OPS',
                        level: 1,
                        manager_name: 'Operations Director',
                        location: 'Head Office',
                        children_count: 4
                    }
                ]
            }
        ];
        displayHierarchy(mockData);
    }

    function displayHierarchy(departments) {
        const container = $('#departmentHierarchy');
        if (!departments || departments.length === 0) {
            container.html(`
                <div class="text-center py-4">
                    <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">No departments found. Click "Add Department" to get started.</p>
                </div>
            `);
            return;
        }
        container.html(buildHierarchyHTML(departments));
    }

    function buildHierarchyHTML(departments) {
        let html = '<ul class="dept-tree">';
        departments.forEach(dept => {
            html += `
                <li>
                    <div class="dept-node">
                        <div class="level-indicator level-${dept.level || 0}"></div>
                        <i class="fas ${dept.children && dept.children.length > 0 ? 'fa-building' : 'fa-briefcase'} dept-icon"></i>
                        <div class="dept-info">
                            <div>
                                <span class="dept-name">${dept.name}</span>
                                <span class="dept-code">${dept.code}</span>
                            </div>
                            ${dept.manager_name ? `<div class="dept-manager"><i class="fas fa-user-tie me-1"></i>${dept.manager_name}</div>` : ''}
                            <div class="dept-details">
                                ${dept.location ? `<i class="fas fa-map-marker-alt me-1"></i>${dept.location}` : ''} 
                                ${dept.children_count > 0 ? `• ${dept.children_count} sub-departments` : ''}
                            </div>
                        </div>
                        <div class="dept-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="editDepartment('${dept.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="addChildDepartment('${dept.id}')" title="Add Sub-Department">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartment('${dept.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${dept.children && dept.children.length > 0 ? buildHierarchyHTML(dept.children) : ''}
                </li>
            `;
        });
        html += '</ul>';
        return html;
    }

    function loadDepartmentList() {
        $.get('/departments/api/departments')
            .done(function(data) {
                if (data.success && data.data) {
                    allDepartments = data.data;
                    displayDepartmentList(data.data);
                    populateParentDropdown(data.data);
                } else {
                    showMockDepartmentList();
                }
            })
            .fail(function(xhr) {
                console.error('Error loading department list:', xhr);
                showMockDepartmentList();
            });
    }

    function showMockDepartmentList() {
        const mockData = [
            {
                id: '1',
                name: 'Chief Executive Office',
                code: 'CEO',
                level: 0,
                manager_name: 'Chief Executive Officer',
                location: 'Head Office',
                children_count: 5,
                budget: 5000000
            },
            {
                id: '2',
                name: 'Investment Division',
                code: 'INV',
                level: 1,
                manager_name: 'Investment Director',
                location: 'Head Office',
                children_count: 3,
                budget: 2000000
            }
        ];
        allDepartments = mockData;
        displayDepartmentList(mockData);
        populateParentDropdown(mockData);
    }

    function displayDepartmentList(departments) {
        const tbody = $('#departmentTableBody');
        tbody.empty();
        
        if (!departments || departments.length === 0) {
            tbody.html(`
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No departments found. Click "Add Department" to get started.</p>
                    </td>
                </tr>
            `);
            return;
        }
        
        departments.forEach(dept => {
            const budget = dept.budget ? `ZMW ${parseFloat(dept.budget).toLocaleString()}` : 'N/A';
            const row = `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="level-indicator level-${dept.level || 0}" style="width: 3px; height: 20px; margin-right: 8px;"></div>
                            <div>
                                <div class="fw-semibold">${dept.name}</div>
                                <small class="text-muted">${dept.description || 'No description'}</small>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-secondary">${dept.code}</span></td>
                    <td>${dept.manager_name || 'N/A'}</td>
                    <td>${dept.location || 'N/A'}</td>
                    <td><span class="badge bg-info">Level ${dept.level || 0}</span></td>
                    <td>${dept.children_count || 0}</td>
                    <td>${budget}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editDepartment('${dept.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteDepartment('${dept.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    function populateParentDropdown(departments) {
        const select = $('#parentId');
        select.html('<option value="">None (Top Level)</option>');
        
        departments.forEach(dept => {
            select.append(`<option value="${dept.id}">${dept.full_path || dept.name}</option>`);
        });
    }

    function showCreateModal() {
        currentDeptId = null;
        $('#modalTitle').text('Add Department');
        $('#departmentForm')[0].reset();
        const modal = new bootstrap.Modal($('#departmentModal')[0]);
        modal.show();
    }

    function editDepartment(deptId) {
        currentDeptId = deptId;
        $('#modalTitle').text('Edit Department');
        
        const dept = allDepartments.find(d => d.id === deptId);
        if (dept) {
            $('#deptName').val(dept.name || '');
            $('#deptCode').val(dept.code || '');
            $('#parentId').val(dept.parent_id || '');
            $('#location').val(dept.location || '');
            $('#managerName').val(dept.manager_name || '');
            $('#managerEmail').val(dept.manager_email || '');
            $('#costCenter').val(dept.cost_center || '');
            $('#budget').val(dept.budget || '');
            $('#description').val(dept.description || '');
        }
        
        const modal = new bootstrap.Modal($('#departmentModal')[0]);
        modal.show();
    }

    function addChildDepartment(parentId) {
        currentDeptId = null;
        $('#modalTitle').text('Add Sub-Department');
        $('#departmentForm')[0].reset();
        $('#parentId').val(parentId);
        const modal = new bootstrap.Modal($('#departmentModal')[0]);
        modal.show();
    }

    function saveDepartment() {
        const formData = {
            name: $('#deptName').val(),
            code: $('#deptCode').val(),
            parent_id: $('#parentId').val() || null,
            location: $('#location').val(),
            manager_name: $('#managerName').val(),
            manager_email: $('#managerEmail').val(),
            cost_center: $('#costCenter').val(),
            budget: parseFloat($('#budget').val()) || null,
            description: $('#description').val()
        };
        
        const url = currentDeptId ? `/departments/api/department/${currentDeptId}` : '/departments/api/department';
        const method = currentDeptId ? 'PUT' : 'POST';
        
        $.ajax({
            url: url,
            method: method,
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(data) {
                if (data.id || data.message) {
                    bootstrap.Modal.getInstance($('#departmentModal')[0]).hide();
                    loadDepartmentStats();
                    loadDepartmentHierarchy();
                    loadDepartmentList();
                    toastr.success('Department saved successfully!');
                } else {
                    toastr.error('Error saving department: ' + (data.error || 'Unknown error'));
                }
            },
            error: function(xhr) {
                console.error('Error saving department:', xhr);
                toastr.error('Error saving department');
            }
        });
    }

    function deleteDepartment(deptId) {
        if (confirm('Are you sure you want to delete this department? This action will deactivate the department.')) {
            $.ajax({
                url: `/departments/api/department/${deptId}`,
                method: 'DELETE',
                success: function(data) {
                    if (data.message) {
                        loadDepartmentStats();
                        loadDepartmentHierarchy();
                        loadDepartmentList();
                        toastr.success('Department deleted successfully!');
                    } else {
                        toastr.error('Error deleting department: ' + (data.error || 'Unknown error'));
                    }
                },
                error: function(xhr) {
                    console.error('Error deleting department:', xhr);
                    toastr.error('Error deleting department');
                }
            });
        }
    }

    function showOrgChart() {
        // Activate the org chart tab
        const orgChartTab = new bootstrap.Tab(document.querySelector('[data-bs-target="#chartView"]'));
        orgChartTab.show();
    }
</script>
{% endblock %}