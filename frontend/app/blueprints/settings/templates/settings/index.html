<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - NAPSA ERM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .settings-card {
            transition: transform 0.2s;
        }
        .settings-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .setting-group {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #0d6efd;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .badge-modified {
            background-color: #ffc107;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h2><i class="bi bi-gear"></i> System Settings</h2>
                <p class="text-muted">Configure and manage NAPSA ERM system settings</p>
            </div>
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="exportSettings()">
                        <i class="bi bi-download"></i> Export
                    </button>
                    <button class="btn btn-outline-success" onclick="backupSettings()">
                        <i class="bi bi-shield-check"></i> Backup
                    </button>
                    <button class="btn btn-outline-warning" onclick="resetSettings()">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Last Modified Info -->
        <div class="alert alert-info mb-4" id="lastModified" style="display: none;">
            <i class="bi bi-info-circle"></i> 
            <span id="modificationInfo">Settings loaded successfully</span>
        </div>

        <div class="row">
            <!-- Settings Navigation -->
            <div class="col-lg-3 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="bi bi-list"></i> Categories</h6>
                    </div>
                    <div class="card-body p-0">
                        <ul class="nav nav-pills flex-column" id="settingsNav" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="pill" href="#general-settings">
                                    <i class="bi bi-gear"></i> General
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#security-settings">
                                    <i class="bi bi-shield-lock"></i> Security
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#notification-settings">
                                    <i class="bi bi-bell"></i> Notifications
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#integration-settings">
                                    <i class="bi bi-link-45deg"></i> Integrations
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#risk-settings">
                                    <i class="bi bi-exclamation-triangle"></i> Risk Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#compliance-settings">
                                    <i class="bi bi-check-circle"></i> Compliance
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#system-settings">
                                    <i class="bi bi-cpu"></i> System
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Settings Content -->
            <div class="col-lg-9">
                <div class="tab-content" id="settingsContent">
                    <!-- General Settings -->
                    <div class="tab-pane fade show active" id="general-settings">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between">
                                <h5><i class="bi bi-gear"></i> General Settings</h5>
                                <button class="btn btn-sm btn-primary" onclick="saveCategory('general')">Save Changes</button>
                            </div>
                            <div class="card-body">
                                <div class="setting-group">
                                    <h6>Organization Information</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Organization Name</label>
                                            <input type="text" class="form-control" id="orgName" value="National Pension Scheme Authority">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Country</label>
                                            <select class="form-select" id="country">
                                                <option value="ZM" selected>Zambia</option>
                                                <option value="US">United States</option>
                                                <option value="GB">United Kingdom</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Timezone</label>
                                            <select class="form-select" id="timezone">
                                                <option value="Africa/Lusaka" selected>Africa/Lusaka</option>
                                                <option value="UTC">UTC</option>
                                                <option value="America/New_York">America/New_York</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Language</label>
                                            <select class="form-select" id="language">
                                                <option value="en" selected>English</option>
                                                <option value="fr">French</option>
                                                <option value="es">Spanish</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h6>Display Preferences</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Date Format</label>
                                            <select class="form-select" id="dateFormat">
                                                <option value="DD/MM/YYYY" selected>DD/MM/YYYY</option>
                                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Currency</label>
                                            <select class="form-select" id="currency">
                                                <option value="ZMW" selected>Zambian Kwacha (ZMW)</option>
                                                <option value="USD">US Dollar (USD)</option>
                                                <option value="EUR">Euro (EUR)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="tab-pane fade" id="security-settings">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between">
                                <h5><i class="bi bi-shield-lock"></i> Security Settings</h5>
                                <button class="btn btn-sm btn-primary" onclick="saveCategory('security')">Save Changes</button>
                            </div>
                            <div class="card-body">
                                <div class="setting-group">
                                    <h6>Authentication</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="mfaRequired" checked>
                                                <label class="form-check-label" for="mfaRequired">
                                                    Require Multi-Factor Authentication
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Session Timeout (minutes)</label>
                                            <input type="number" class="form-control" id="sessionTimeout" value="30" min="5" max="480">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Password Policy</label>
                                            <select class="form-select" id="passwordPolicy">
                                                <option value="standard" selected>Standard</option>
                                                <option value="strong">Strong</option>
                                                <option value="enterprise">Enterprise</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Failed Login Attempts</label>
                                            <input type="number" class="form-control" id="maxLoginAttempts" value="5" min="3" max="10">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h6>Data Protection</h6>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="dataEncryption" checked>
                                        <label class="form-check-label" for="dataEncryption">
                                            Enable Data Encryption at Rest
                                        </label>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="auditLogging" checked>
                                        <label class="form-check-label" for="auditLogging">
                                            Enable Comprehensive Audit Logging
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="tab-pane fade" id="notification-settings">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between">
                                <h5><i class="bi bi-bell"></i> Notification Settings</h5>
                                <button class="btn btn-sm btn-primary" onclick="saveCategory('notifications')">Save Changes</button>
                            </div>
                            <div class="card-body">
                                <div class="setting-group">
                                    <h6>Email Notifications</h6>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailRiskAlerts" checked>
                                        <label class="form-check-label" for="emailRiskAlerts">
                                            Risk Alerts
                                        </label>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailIncidents" checked>
                                        <label class="form-check-label" for="emailIncidents">
                                            Incident Notifications
                                        </label>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailCompliance" checked>
                                        <label class="form-check-label" for="emailCompliance">
                                            Compliance Updates
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h6>System Notifications</h6>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="browserNotifications" checked>
                                        <label class="form-check-label" for="browserNotifications">
                                            Browser Notifications
                                        </label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Notification Frequency</label>
                                            <select class="form-select" id="notificationFrequency">
                                                <option value="immediate" selected>Immediate</option>
                                                <option value="hourly">Hourly</option>
                                                <option value="daily">Daily</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Integration Settings -->
                    <div class="tab-pane fade" id="integration-settings">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between">
                                <h5><i class="bi bi-link-45deg"></i> Integration Settings</h5>
                                <button class="btn btn-sm btn-primary" onclick="saveCategory('integrations')">Save Changes</button>
                            </div>
                            <div class="card-body">
                                <div class="setting-group">
                                    <h6>API Configuration</h6>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">OpenSanctions API URL</label>
                                            <input type="url" class="form-control" id="openSanctionsUrl" 
                                                   value="http://45.93.137.89:8000" readonly>
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">API Key</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="apiKey" 
                                                       value="69c2cedca0bea99a972de11e28791d57">
                                                <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKey()">
                                                    <i class="bi bi-eye" id="apiKeyToggle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h6>External Systems</h6>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enableLdap">
                                        <label class="form-check-label" for="enableLdap">
                                            Enable LDAP Integration
                                        </label>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enableSso">
                                        <label class="form-check-label" for="enableSso">
                                            Enable Single Sign-On (SSO)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Settings -->
                    <div class="tab-pane fade" id="risk-settings">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between">
                                <h5><i class="bi bi-exclamation-triangle"></i> Risk Management Settings</h5>
                                <button class="btn btn-sm btn-primary" onclick="saveCategory('risk')">Save Changes</button>
                            </div>
                            <div class="card-body">
                                <div class="setting-group">
                                    <h6>Risk Thresholds</h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Low Risk Threshold</label>
                                            <input type="number" class="form-control" id="lowRiskThreshold" value="3" min="1" max="10">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Medium Risk Threshold</label>
                                            <input type="number" class="form-control" id="mediumRiskThreshold" value="6" min="1" max="15">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">High Risk Threshold</label>
                                            <input type="number" class="form-control" id="highRiskThreshold" value="10" min="1" max="25">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h6>Assessment Configuration</h6>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="autoRiskCalculation" checked>
                                        <label class="form-check-label" for="autoRiskCalculation">
                                            Enable Automatic Risk Score Calculation
                                        </label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Review Frequency (days)</label>
                                            <input type="number" class="form-control" id="reviewFrequency" value="90" min="30" max="365">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Settings -->
                    <div class="tab-pane fade" id="compliance-settings">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between">
                                <h5><i class="bi bi-check-circle"></i> Compliance Settings</h5>
                                <button class="btn btn-sm btn-primary" onclick="saveCategory('compliance')">Save Changes</button>
                            </div>
                            <div class="card-body">
                                <div class="setting-group">
                                    <h6>Active Frameworks</h6>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="zppaFramework" checked>
                                        <label class="form-check-label" for="zppaFramework">
                                            Zambia Personal Data Protection Act (ZPPA)
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="bozFramework" checked>
                                        <label class="form-check-label" for="bozFramework">
                                            Bank of Zambia Regulations
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="napsaFramework" checked>
                                        <label class="form-check-label" for="napsaFramework">
                                            NAPSA Act
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="employmentFramework" checked>
                                        <label class="form-check-label" for="employmentFramework">
                                            Employment Act
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Settings -->
                    <div class="tab-pane fade" id="system-settings">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between">
                                <h5><i class="bi bi-cpu"></i> System Settings</h5>
                                <button class="btn btn-sm btn-primary" onclick="saveCategory('system')">Save Changes</button>
                            </div>
                            <div class="card-body">
                                <div class="setting-group">
                                    <h6>Performance</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Cache Duration (minutes)</label>
                                            <input type="number" class="form-control" id="cacheDuration" value="60" min="5" max="1440">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Page Size</label>
                                            <select class="form-select" id="pageSize">
                                                <option value="10">10</option>
                                                <option value="25" selected>25</option>
                                                <option value="50">50</option>
                                                <option value="100">100</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-group">
                                    <h6>Maintenance</h6>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="maintenanceMode">
                                        <label class="form-check-label" for="maintenanceMode">
                                            Maintenance Mode
                                        </label>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="debugMode">
                                        <label class="form-check-label" for="debugMode">
                                            Debug Mode
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Export Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Export Category</label>
                        <select class="form-select" id="exportCategory">
                            <option value="all">All Settings</option>
                            <option value="general">General</option>
                            <option value="security">Security</option>
                            <option value="notifications">Notifications</option>
                            <option value="integrations">Integrations</option>
                            <option value="risk">Risk Management</option>
                            <option value="compliance">Compliance</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="json">JSON</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="performExport()">Export</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allSettings = {};
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
        });

        function loadSettings() {
            fetch('/settings/api/settings')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allSettings = data.data;
                        populateSettings(allSettings);
                        updateLastModified();
                    }
                })
                .catch(error => console.error('Error loading settings:', error));
        }

        function populateSettings(settings) {
            // General settings
            const general = settings.general || {};
            document.getElementById('orgName').value = general.organization_name || 'National Pension Scheme Authority';
            document.getElementById('country').value = general.country || 'ZM';
            document.getElementById('timezone').value = general.timezone || 'Africa/Lusaka';
            document.getElementById('language').value = general.language || 'en';
            document.getElementById('dateFormat').value = general.date_format || 'DD/MM/YYYY';
            document.getElementById('currency').value = general.currency || 'ZMW';

            // Security settings
            const security = settings.security || {};
            document.getElementById('mfaRequired').checked = security.mfa_required !== false;
            document.getElementById('sessionTimeout').value = security.session_timeout || 30;
            document.getElementById('passwordPolicy').value = security.password_policy || 'standard';
            document.getElementById('maxLoginAttempts').value = security.max_login_attempts || 5;
            document.getElementById('dataEncryption').checked = security.data_encryption !== false;
            document.getElementById('auditLogging').checked = security.audit_logging !== false;

            // Notification settings
            const notifications = settings.notifications || {};
            document.getElementById('emailRiskAlerts').checked = notifications.email_risk_alerts !== false;
            document.getElementById('emailIncidents').checked = notifications.email_incidents !== false;
            document.getElementById('emailCompliance').checked = notifications.email_compliance !== false;
            document.getElementById('browserNotifications').checked = notifications.browser_notifications !== false;
            document.getElementById('notificationFrequency').value = notifications.frequency || 'immediate';

            // Integration settings
            const integrations = settings.integrations || {};
            document.getElementById('openSanctionsUrl').value = integrations.opensanctions_url || 'http://45.93.137.89:8000';
            document.getElementById('apiKey').value = integrations.api_key || '69c2cedca0bea99a972de11e28791d57';
            document.getElementById('enableLdap').checked = integrations.enable_ldap === true;
            document.getElementById('enableSso').checked = integrations.enable_sso === true;

            // Risk settings
            const risk = settings.risk || {};
            document.getElementById('lowRiskThreshold').value = risk.low_threshold || 3;
            document.getElementById('mediumRiskThreshold').value = risk.medium_threshold || 6;
            document.getElementById('highRiskThreshold').value = risk.high_threshold || 10;
            document.getElementById('autoRiskCalculation').checked = risk.auto_calculation !== false;
            document.getElementById('reviewFrequency').value = risk.review_frequency || 90;

            // Compliance settings
            const compliance = settings.compliance || {};
            document.getElementById('zppaFramework').checked = compliance.zppa_enabled !== false;
            document.getElementById('bozFramework').checked = compliance.boz_enabled !== false;
            document.getElementById('napsaFramework').checked = compliance.napsa_enabled !== false;
            document.getElementById('employmentFramework').checked = compliance.employment_enabled !== false;

            // System settings
            const system = settings.system || {};
            document.getElementById('cacheDuration').value = system.cache_duration || 60;
            document.getElementById('pageSize').value = system.page_size || 25;
            document.getElementById('maintenanceMode').checked = system.maintenance_mode === true;
            document.getElementById('debugMode').checked = system.debug_mode === true;
        }

        function saveCategory(category) {
            const categoryData = gatherCategoryData(category);
            
            fetch(`/settings/api/settings/${category}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(categoryData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    allSettings[category] = data.data;
                    updateLastModified();
                } else {
                    showAlert('danger', 'Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                showAlert('danger', 'Failed to save settings');
            });
        }

        function gatherCategoryData(category) {
            const data = {};
            
            switch (category) {
                case 'general':
                    data.organization_name = document.getElementById('orgName').value;
                    data.country = document.getElementById('country').value;
                    data.timezone = document.getElementById('timezone').value;
                    data.language = document.getElementById('language').value;
                    data.date_format = document.getElementById('dateFormat').value;
                    data.currency = document.getElementById('currency').value;
                    break;
                    
                case 'security':
                    data.mfa_required = document.getElementById('mfaRequired').checked;
                    data.session_timeout = parseInt(document.getElementById('sessionTimeout').value);
                    data.password_policy = document.getElementById('passwordPolicy').value;
                    data.max_login_attempts = parseInt(document.getElementById('maxLoginAttempts').value);
                    data.data_encryption = document.getElementById('dataEncryption').checked;
                    data.audit_logging = document.getElementById('auditLogging').checked;
                    break;
                    
                case 'notifications':
                    data.email_risk_alerts = document.getElementById('emailRiskAlerts').checked;
                    data.email_incidents = document.getElementById('emailIncidents').checked;
                    data.email_compliance = document.getElementById('emailCompliance').checked;
                    data.browser_notifications = document.getElementById('browserNotifications').checked;
                    data.frequency = document.getElementById('notificationFrequency').value;
                    break;
                    
                case 'integrations':
                    data.opensanctions_url = document.getElementById('openSanctionsUrl').value;
                    data.api_key = document.getElementById('apiKey').value;
                    data.enable_ldap = document.getElementById('enableLdap').checked;
                    data.enable_sso = document.getElementById('enableSso').checked;
                    break;
                    
                case 'risk':
                    data.low_threshold = parseInt(document.getElementById('lowRiskThreshold').value);
                    data.medium_threshold = parseInt(document.getElementById('mediumRiskThreshold').value);
                    data.high_threshold = parseInt(document.getElementById('highRiskThreshold').value);
                    data.auto_calculation = document.getElementById('autoRiskCalculation').checked;
                    data.review_frequency = parseInt(document.getElementById('reviewFrequency').value);
                    break;
                    
                case 'compliance':
                    data.zppa_enabled = document.getElementById('zppaFramework').checked;
                    data.boz_enabled = document.getElementById('bozFramework').checked;
                    data.napsa_enabled = document.getElementById('napsaFramework').checked;
                    data.employment_enabled = document.getElementById('employmentFramework').checked;
                    break;
                    
                case 'system':
                    data.cache_duration = parseInt(document.getElementById('cacheDuration').value);
                    data.page_size = parseInt(document.getElementById('pageSize').value);
                    data.maintenance_mode = document.getElementById('maintenanceMode').checked;
                    data.debug_mode = document.getElementById('debugMode').checked;
                    break;
            }
            
            return data;
        }

        function exportSettings() {
            const modal = new bootstrap.Modal(document.getElementById('exportModal'));
            modal.show();
        }

        function performExport() {
            const category = document.getElementById('exportCategory').value;
            const format = document.getElementById('exportFormat').value;
            
            fetch('/settings/api/settings/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    category: category,
                    format: format
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create and download file
                    const blob = new Blob([data.data.content], { type: data.data.content_type });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = data.data.filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
                    showAlert('success', 'Settings exported successfully!');
                } else {
                    showAlert('danger', 'Export failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Export error:', error);
                showAlert('danger', 'Export failed');
            });
        }

        function backupSettings() {
            fetch('/settings/api/settings/backup', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create and download backup file
                    const blob = new Blob([data.data.content], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = data.data.filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                    showAlert('success', data.message);
                } else {
                    showAlert('danger', 'Backup failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Backup error:', error);
                showAlert('danger', 'Backup failed');
            });
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
                fetch('/settings/api/settings/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category: 'all'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allSettings = data.data;
                        populateSettings(allSettings);
                        updateLastModified();
                        showAlert('success', data.message);
                    } else {
                        showAlert('danger', 'Reset failed: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Reset error:', error);
                    showAlert('danger', 'Reset failed');
                });
            }
        }

        function toggleApiKey() {
            const apiKeyInput = document.getElementById('apiKey');
            const toggleIcon = document.getElementById('apiKeyToggle');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.className = 'bi bi-eye-slash';
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.className = 'bi bi-eye';
            }
        }

        function updateLastModified() {
            const lastModifiedElement = document.getElementById('lastModified');
            const modificationInfoElement = document.getElementById('modificationInfo');
            
            // Find the most recent modification across all categories
            let lastModified = null;
            let modifiedBy = 'System';
            
            Object.values(allSettings).forEach(category => {
                if (category.last_modified) {
                    const categoryDate = new Date(category.last_modified);
                    if (!lastModified || categoryDate > lastModified) {
                        lastModified = categoryDate;
                        modifiedBy = category.modified_by || 'System';
                    }
                }
            });
            
            if (lastModified) {
                modificationInfoElement.textContent = `Last modified: ${lastModified.toLocaleString()} by ${modifiedBy}`;
                lastModifiedElement.style.display = 'block';
            }
        }

        function showAlert(type, message) {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.minWidth = '300px';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }
    </script>
</body>
</html>